<!DOCTYPE html>
<html lang="en" class="h-100">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, shrink-to-fit=9">
	<meta name="description" content="Gambolthemes">
	<meta name="author" content="Gambolthemes">
	<title>Barren - Simple Online Event Ticketing System</title>

	<!-- Favicon Icon -->
	<link rel="icon" type="image/png" href="images/fav.png">

	<!-- Stylesheets -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
		rel="stylesheet">
	<link href='vendor/unicons-2.0.1/css/unicons.css' rel='stylesheet'>
	<link href="css/style.css" rel="stylesheet">
	<link href="css/vertical-responsive-menu.min.css" rel="stylesheet">
	<link href="css/datepicker.min.css" rel="stylesheet">
	<link href="css/responsive.css" rel="stylesheet">
	<link href="css/night-mode.css" rel="stylesheet">

	<!-- Vendor Stylesheets -->
	<link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
	<link href="vendor/OwlCarousel/assets/owl.carousel.css" rel="stylesheet">
	<link href="vendor/OwlCarousel/assets/owl.theme.default.min.css" rel="stylesheet">
	<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="vendor/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<style>
		.allInput {
			border: 1px solid white;
		}

		.backuser {
			width: 230px;
		}

		.name {
			width: 60px;
		}

		.iconbutton {
			width: 20px;
			height: 20px;
			vertical-align: top;
		}

		.editbutton {
			width: 15px;
			height: 15px;
			margin-top: 3px;


		}

		.menu1,
		.menu2,
		.menu3 {
			display: flex;
			flex-direction: column;
		}

		.menu-item {
			padding: 10px;
			/* border: 1px solid gray; */
			cursor: pointer;
		}

		.menu-item:hover {
			background-color: lightgray;
		}

		.menu-item.active {
			background-color: gray;
			color: white;
		}

		.btn-activate {
			background-color: #31cf56;
			color: #fff;
			border: none;
			border-radius: 4px;
			padding: 6px 12px;
			font-size: 5px;
			font-weight: bold;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.btn-activate:hover {
			background-color: #218838;
		}
	</style>
</head>

<body class="d-flex flex-column h-100">
	<!-- Invite Team Member Model Start-->
	<div class="modal fade" id="inviteTeamModal" tabindex="-1" aria-labelledby="inviteTeamModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="inviteTeamModalLabel">邀請新成員</h5>
					<button type="button" class="close-model-btn" data-bs-dismiss="modal" aria-label="Close"><i
							class="uil uil-multiply"></i></button>
				</div>
				<div class="modal-body">
					<div class="model-content main-form">
						<div class="form-group mt-30">
							<label class="form-label">姓名</label>
							<input id="baname" class="form-control h_40" type="text" placeholder="請輸入姓名.." value="">
						</div>
						<div class="form-group mt-30">
							<label class="form-label">帳號</label>
							<input id="baaccount" class="form-control h_40" type="text" placeholder="請輸入帳號.." value="">
						</div>
						<div class="form-group mt-30">
							<label class="form-label">E-mail</label>
							<input id="baemail" class="form-control h_40" type="email" placeholder="請輸入email.."
								value="">
						</div>
						<div class="form-group mt-30">
							<label class="form-label">電話</label>
							<input id="bacell" class="form-control h_40" type="tel" placeholder="請輸入email.." value="">
						</div>
						<div class="form-group mt-30">
							<label class="form-label">密碼(預設)</label>
							<input id="bapassword" class="form-control h_40" type="text" value="Aa123456" readonly>
						</div>
						<div class="form-group mt-30">
							<label class="form-label">權限指派</label>
							<select id="baroleno" class="selectpicker" title="Select Role">
								<option value="1">業務統籌</option>
								<option value="2">商品管理者</option>
								<option value="3">節目管理者</option>
								<option value="4">後台管理者</option>
								<option value="5">客服人員</option>
								<option value="6">驗票人員</option>
								<option value="7">後台使用者</option>
							</select>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="co-main-btn min-width btn-hover h_40"
						data-bs-dismiss="modal">取消</button>
					<button type="button" id="inviteNewBu" class="main-btn min-width btn-hover h_40">邀請新成員</button>
				</div>
			</div>
		</div>
	</div>
	<!-- ------------------------------------------------------------------------------------------------------------ -->
	<div class="modal fade" id="inviteTeamModal2" tabindex="-1" aria-labelledby="inviteTeamModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">新建角色</h5>
					<button type="button" class="close-model-btn" data-bs-dismiss="modal" aria-label="Close"><i
							class="uil uil-multiply"></i></button>
				</div>
				<div class="modal-body">
					<div class="model-content main-form">
						<div class="form-group mt-30">
							<label class="form-label">角色名稱</label>
							<input id="rolename" class="form-control h_40" type="text" placeholder="請輸入角色名稱.." value="">
						</div>
						<div class="form-group mt-30">
							<label class="form-label">角色狀態</label>
							<input id="choice" type="radio" value="0" name="rolestatus" checked>
							<label for="choice">停用</label>
							<input id="choice2" type="radio" value="1" name="rolestatus">
							<label for="choice2">啟用</label>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" id="roleCancel" class="co-main-btn min-width btn-hover h_40"
						data-bs-dismiss="modal">取消</button>
					<button type="button" id="addNewRole" class="main-btn min-width btn-hover h_40">新增後台角色</button>
				</div>
			</div>
		</div>
	</div>

	<!-- -----------------------------------------以下角色權限使用------------------------------------------------------ -->
	<div class="modal fade" id="itm" tabindex="-1" aria-labelledby="inviteTeamModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title"><b>權限瀏覽</b></h5>
					<button type="button" class="close-model-btn" data-bs-dismiss="modal" aria-label="Close"><i
							class="uil uil-multiply"></i></button>
				</div>
				<div class="modal-body">
					<div class="model-content main-form">
						<div class="form-group mt-30">
							<p class="form-label"><b>目前角色:</b></p>
							<p id="currentRole"></p>
						</div>
						<div class="form-group mt-30">
							<p class="form-label"><b>負責工作/權限:</b></p>
							<p id="workAuthority"></p>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="co-main-btn min-width btn-hover h_40"
						data-bs-dismiss="modal">Cancel</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Invite Team Member Model End-->
	<!-- Header Start-->
	<header class="header">
		<div class="header-inner">
			<nav
				class="navbar navbar-expand-lg bg-barren barren-head navbar fixed-top justify-content-sm-start pt-0 pb-0 ps-lg-0 pe-2">
				<div class="container-fluid ps-0">
					<button type="button" id="toggleMenu" class="toggle_menu">
						<i class="fa-solid fa-bars-staggered"></i>
					</button>
					<button id="collapse_menu" class="collapse_menu me-4">
						<i class="fa-solid fa-bars collapse_menu--icon "></i>
						<span class="collapse_menu--label"></span>
					</button>
					<button class="navbar-toggler order-3 ms-2 pe-0" type="button" data-bs-toggle="offcanvas"
						data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
						<span class="navbar-toggler-icon">
							<i class="fa-solid fa-bars"></i>
						</span>
					</button>
					<a class="navbar-brand order-1 order-lg-0 ml-lg-0 ml-2 me-auto" href="index.html">
						<div class="res-main-logo">
							<img src="images/logo-icon.svg" alt="">
						</div>
						<div class="main-logo" id="logo">
							<img src="images/logo.svg" alt="">
							<img class="logo-inverse" src="images/dark-logo.svg" alt="">
						</div>
					</a>
					<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar"
						aria-labelledby="offcanvasNavbarLabel">
						<div class="offcanvas-header">
							<div class="offcanvas-logo" id="offcanvasNavbarLabel">
								<img src="images/logo-icon.svg" alt="">
							</div>
							<button type="button" class="close-btn" data-bs-dismiss="offcanvas" aria-label="Close">
								<i class="fa-solid fa-xmark"></i>
							</button>
						</div>
						<div class="offcanvas-body">
							<div class="offcanvas-top-area">
								<div class="create-bg">
									<a href="create.html" class="offcanvas-create-btn">
										<i class="fa-solid fa-calendar-days"></i>
										<span>Create Event</span>
									</a>
								</div>
							</div>
							<ul class="navbar-nav justify-content-end flex-grow-1 pe_5">
								<li class="nav-item">
									<a class="nav-link" href="back-users-profile.html">
										<i class="fa-solid fa-right-left me-2"></i>使用者管理
									</a>
								</li>
								<!-- <li class="nav-item">
									<a class="nav-link" href="explore_events.html">
										<i class="fa-solid fa-compass me-2"></i>Explore Events
									</a>
								</li> -->
							</ul>
						</div>
						<div class="offcanvas-footer">
							<div class="offcanvas-social">
								<h5>Follow Us</h5>
								<ul class="social-links">
									<li><a href="#" class="social-link"><i class="fab fa-facebook-square"></i></a>
									</li>
									<li><a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
									</li>
									<li><a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
									</li>
									<li><a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
									</li>
									<li><a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
									</li>
								</ul>
							</div>
						</div>
					</div>
					<div class="right-header order-2">
						<ul class="align-self-stretch">
							<!-- <li>
								<a href="create.html" class="create-btn btn-hover">
									<i class="fa-solid fa-calendar-days"></i>
									<span>Create Event</span>
								</a>
							</li> -->
							<li class="dropdown account-dropdown order-3">
								<a href="#" class="account-link" role="button" id="accountClick"
									data-bs-auto-close="outside" data-bs-toggle="dropdown" aria-expanded="false">
									<img src="images/profile-imgs/img-13.jpg" alt="">
									<i class="fas fa-caret-down arrow-icon"></i>
								</a>
								<ul class="dropdown-menu dropdown-menu-account dropdown-menu-end"
									aria-labelledby="accountClick">
									<li>
										<div class="dropdown-account-header">
											<div class="account-holder-avatar">
												<img src="images/profile-imgs/img-13.jpg" alt="">
											</div>
											<h5>John Doe</h5>
											<p>johndoe@example.com</p>
										</div>
									</li>
									<li class="profile-link">
										<!-- <a href="back-users-profile.html" class="link-item">我的帳戶</a> -->
										<a href="front-users-mem-sign-in.html" class="link-item">登出</a>
									</li>
								</ul>
							</li>
							<li>
								<div class="night_mode_switch__btn">
									<div id="night-mode" class="fas fa-moon fa-sun"></div>
								</div>
							</li>
						</ul>
					</div>
				</div>
			</nav>
			<div class="overlay"></div>
		</div>
	</header>
	<!-- Header End-->
	<!-- Left Sidebar Start -->
	<nav class="vertical_nav">
		<div class="left_section menu_left" id="js-menu">
			<div class="left_section">
				<ul>
					<li class="menu--item">
						<a href="back-users-host.html" class="menu--link" title="Members" data-bs-toggle="tooltip"
							data-bs-placement="right">
							<!--class="active" 就是點選menu後按鈕呈現深色背景的狀態-->
							<i class="fa-solid fa-square-plus menu--icon"></i>
							<span class="menu--label">主辦單位管理</span>
						</a>
					</li>
					<li class="menu--item">
						<a href="back-users-member.html" class="menu--link " title="Members" data-bs-toggle="tooltip"
							data-bs-placement="right">
							<i class="fa-solid fa-user-group menu--icon"></i>
							<span class="menu--label">會員資訊管理</span>
						</a>
					</li>
					<li class="menu--item">
						<a href="back-users-my-team.html" class="menu--link team-lock active" title="My Team"
							data-bs-toggle="tooltip" data-bs-placement="right">
							<!--↑class="active" 就是點選menu後按鈕呈現深色背景的狀態-->
							<i class="fa-solid fa-user-group menu--icon"></i>
							<span class="menu--label">後台帳號管理</span>
						</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>
	<!-- Left Sidebar End -->
	<!-- Body Start -->
	<div class="wrapper wrapper-body">
		<div class="dashboard-body">
			<div class="container-fluid">
				<div class="row">
					<div class="col-md-12">
						<div class="d-main-title">
							<h3><i class="fa-solid fa-user-group me-3"></i>後台帳號管理</h3>
						</div>
					</div>
					<div class="col-md-12">
						<div class="conversion-setup">
							<div class="main-card mt-5">
								<div class="dashboard-wrap-content p-4">
									<div class="d-md-flex flex-wrap align-items-center">
										<div class="nav custom2-tabs btn-group" role="tablist">
											<button class="tab-link ms-0 active back-user" data-bs-toggle="tab"
												data-bs-target="#overview-tab" type="button" role="tab"
												aria-controls="overview-tab" aria-selected="true">後台使用者</button>
											<button class="tab-link  func-set" data-bs-toggle="tab"
												data-bs-target="#role-tab" type="button" role="tab"
												aria-controls="role-tab" aria-selected="false">權限功能設定</button>
										</div>
										<div class="col-lg-3 col-md-6 hide" style="width: 100px; margin-left: 125px;">
											<select class="selectpicker sp">
												<option value="1">啟用中</option>
												<option value="0">停用中</option>
											</select>
										</div>
										<div style="width: 50px; margin-left: 10px;">
											<div class="form-group">
												<div class="relative-input position-relative hide2">
													<input class="form-control h_40" id="search" type="text" placeholder="搜尋使用者..."
														value="">
													<i class="uil uil-search"></i>
												</div>
											</div>
										</div>
										<div class="rs ms-auto mt_r4">
											<button class="main-btn btn-hover h_40 w-100 changebutton"
												data-bs-toggle="modal" data-bs-target="#inviteTeamModal">新增使用者</button>
										</div>
									</div>

								</div>


							</div>
							<div class="tab-content">
								<div class="tab-pane fade active show" id="overview-tab" role="tabpanel">
									<div class="table-card mt-4">
										<div class="main-table">
											<div class="table-responsive">
												<table class="table">
													<thead class="thead-dark">
														<tr>
															<th scope="col">後台帳號</th>
															<th scope="col">姓名</th>
															<th scope="col">Email</th>
															<th scope="col">角色</th>
															<th scope="col">聯絡電話</th>
															<th scope="col">編輯</th>
															<th scope="col" id="auth">停權</th>
														</tr>
													</thead>
													<tbody>
														<tr>
															<!-- 放入表單內容 -->
														</tr>
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>
								<div class="tab-pane fade" id="role-tab" role="tabpanel">
									<div class="role-slider-content mt-4">
										<div class="owl-carousel role-slider owl-theme">
											<div class="item">
												<div class="main-card">
													<div class="role-header">
														<h6><b>停用角色</b></h6>
														<button class="btn-activate roleAuthButton">啟用</button>
													</div>
													<div class="role-body-content">
														<div class="menu4">
															<!-- 顯示所有停用的角色 -->
														</div>
													</div>
												</div>
											</div>
											<div class="item">
												<div class="main-card">
													<div class="role-header">
														<h6><b>後台角色</b></h6>
														<button class="btn-activate roleAuthButton">停用</button>
													</div>
													<div class="role-body-content">
														<div class="menu1">
															<!--顯示所有啟用的角色 -->
														</div>
													</div>
												</div>
											</div>
											<div class="item">
												<div class="main-card">
													<div class="role-header">
														<h6><b>角色擁有權限</b></h6>
														<button class="btn-activate removefunc">移除</button>
													</div>
													<div class="role-body-content">
														<div class="menu2">
															<!-- 顯示被點選角色擁有的功能 -->
														</div>
													</div>
												</div>
											</div>
											<div class="item">
												<div class="main-card">
													<div class="role-header">
														<h6><b>剩餘功能權限</b></h6>
														<button class="btn-activate addfunc">加入</button>
													</div>
													<div class="role-body-content">
														<div class="menu3">
															<!-- 顯示被點選角色沒有的功能 -->
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Body End -->

	<script src="js/vertical-responsive-menu.min.js"></script>
	<script src="js/jquery-3.6.0.min.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="vendor/OwlCarousel/owl.carousel.js"></script>
	<script src="vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
	<script src="js/custom.js"></script>
	<script src="js/datepicker.min.js"></script>
	<script src="js/i18n/datepicker.en.js"></script>
	<script src="js/night-mode.js"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

</body>
<script>
	// 以下為權限功能設定按鈕頁
	function refreshRoleData() {
		fetch('role/garf')
			.then(response => response.json())
			.then(roleData => {
				const status0Div = document.querySelector(".menu4"); //顯示停用角色的div
				const status1Div = document.querySelector(".menu1"); //顯示啟用角色的div

				roleData.forEach(role => {
					// 設定讓啟用/停用角色顯示在不同的區塊
					if (role.rolestatus === 0) {
						status0Div.innerHTML += `<div class="menu-item role-menu" id="role-${role.roleno}" data-value=${role.roleno}>${role.rolename}</div>`;
					} else if (role.rolestatus === 1) {
						status1Div.innerHTML += `<div class="menu-item role-menu" id="role-${role.roleno}" data-value=${role.roleno}>${role.rolename}</div>`;
					}


					//停用or啟用角色選單
					const rolemenu = document.querySelectorAll('.role-menu');
					let selectedValue = null;
					rolemenu.forEach(item => {
						item.addEventListener("click", () => {
							const funcDiv = document.querySelector(".menu2"); //顯示啟用角色擁有功能的div
							const missfuncDiv = document.querySelector(".menu3"); //顯示啟用角色沒有的功能的div

							// 取消"停用or啟用"選單中(div)前一次選中的選項
							if (selectedValue) {
								document.querySelector(`[data-value="${selectedValue}"]`).classList.remove('active');
								funcDiv.innerHTML = ""; //取消前一次顯示的功能列表
							}

							// 設置"停用or啟用"選單中(div)當前選中的選項
							item.classList.add('active');
							selectedValue = item.dataset.value;

							console.log(selectedValue);//測試被選中的角色的value

							//讓點選的角色擁有的功能顯示在功能區塊
							fetch("role/garf")
								.then(response => response.json())
								.then(roleData2 => {
									funcDiv.innerHTML = ""; //因為foreach會讓我印到兩次,要清空前一次印出的功能列表
									missfuncDiv.innerHTML = "";
									roleData2.forEach(role2 => {
										// console.log(selectedValue);//測試被選中的角色的value
										if (`${role2.roleno}` === selectedValue) {   //!!!雷點:role2.roleno 要加‵${}`才能比對
											//該角色有的功能
											const funcSet = new Set();
											for (let func in role2.funcs) {
												funcSet.add(`${func}: ${role2.funcs[func]}`);
											}
											const funclist = Array.from(funcSet);
											for (let func of funclist) {
												funcDiv.innerHTML += `<div class="menu-item hasfuncs" id="${func.split(':')[0]}" data-value="funcno-${func.split(':')[0]}">${func.split(':')[1]}</div>`;
											}


											//該角色沒有的功能
											const missfuncSet = new Set();
											for (let missfunc in role2.nofuncs) {
												missfuncSet.add(`${missfunc}: ${role2.nofuncs[missfunc]}`)
											}
											const nofunclist = Array.from(missfuncSet);
											for (let missfunc of nofunclist) {
												missfuncDiv.innerHTML += `<div class="menu-item nofuncs" id="${missfunc.split(':')[0]}" data-value="funcno-${missfunc.split(':')[0]}">${missfunc.split(':')[1]}</div>`;
												// console.log(missfunc);
											}

										}
										//"角色擁有權限"選單
										const menuItems2 = document.querySelectorAll('.menu2 .menu-item');
										let selectedValue2 = null;
										menuItems2.forEach(item => {
											item.addEventListener('click', () => {
												// 取消之前選中的選項
												if (selectedValue2) {
													document.querySelector(`.menu2 [data-value="${selectedValue2}"]`).classList.remove('active');
												}
												console.log(selectedValue2);
												// 設置當前選中的選項
												item.classList.add('active');
												selectedValue2 = item.dataset.value;

											});
										});

										//"角色沒有的功能"選單
										const menuItems3 = document.querySelectorAll('.menu3 .menu-item');
										let selectedValue3 = null;
										menuItems3.forEach(item => {
											item.addEventListener('click', () => {
												// 取消之前選中的選項
												if (selectedValue3) {
													document.querySelector(`.menu3 [data-value="${selectedValue3}"]`).classList.remove('active');
												}
												console.log(selectedValue3);
												// 設置當前選中的選項
												item.classList.add('active');
												selectedValue3 = item.dataset.value;

											});
										});

									})
								}).catch(error => console.error(error));
						})
					})
				})
			})
	}
	refreshRoleData();

	//啟用/停用角色 的按鈕功能
	$(".roleAuthButton").click(() => {
		if ($(".role-menu.active").length) {
			selectedRoleno = $(".role-menu.active").data("value");
			console.log("被選取的角色" + selectedRoleno);
			fetch(`/role/${selectedRoleno}/roleauth`, {
				method: "POST",
			}).then(success => {
				swal("更改成功!", "您已調整了選擇的角色權限!", "success");
				$(".menu4").empty();
				$(".menu1").empty();
				$(".menu2").empty();
				$(".menu3").empty();
				refreshRoleData();
			})
		} else {
			swal("更改失敗!", "請先點選要調整權限的角色!", "error");
		}
	})

	//角色功能移除
	$(".removefunc").click(() => {
		selectedRoleno = $(".role-menu.active").data("value");//抓到正在被點選的角色(roleno)
		selectedFunc = $(".hasfuncs.active").attr("id");//抓到正在被點選的角色 擁有的功能(funcno)
		const removeRoleauth = {
			roleno: selectedRoleno,
			funcno: selectedFunc
		}
		if ($(".role-menu.active").length && $(".hasfuncs.active").length){
			fetch("/roleauthority/removeRoleauthority", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(removeRoleauth)
			}).then(success => {
				swal("刪除成功!", "您已經為角色刪除了功能!", "success")
					.then(() => {   // 清空func相關的div 重載資料
						$(".menu2").empty();
						$(".menu3").empty();
						fetch("role/garf")
							.then(response => response.json())
							.then(roleData2 => {
								roleData2.forEach(role2 => {
									console.log(selectedRoleno);//test是否接的到被選中的角色的value
									if (`${role2.roleno}` === `${selectedRoleno}`) {
										//該角色有的功能
										const funcSet = new Set();
										for (let func in role2.funcs) {
											funcSet.add(`${func}: ${role2.funcs[func]}`);
										}
										const funclist = Array.from(funcSet);
										for (let func of funclist) {
											$(".menu2").html(function (i, html) {
												return html + `<div class="menu-item hasfuncs" id="${func.split(':')[0]}" data-value="funcno-${func.split(':')[0]}">${func.split(':')[1]}</div>`;
											});
											// console.log(func); //test 顯示角色全部擁有的功能
										}
										//該角色沒有的功能
										const missfuncSet = new Set();
										for (let missfunc in role2.nofuncs) {
											missfuncSet.add(`${missfunc}: ${role2.nofuncs[missfunc]}`)
										}
										const nofunclist = Array.from(missfuncSet);
										for (let missfunc of nofunclist) {
											$(".menu3").html(function (i, html) {
												return html + `<div class="menu-item nofuncs" id="${missfunc.split(':')[0]}" data-value="funcno-${missfunc.split(':')[0]}">${missfunc.split(':')[1]}</div>`;
											});
											// console.log(missfunc); //test 顯示角色全部沒有的功能
										}
									} 
									//"角色擁有權限"選單  點選效果
									const menuItems2 = document.querySelectorAll('.menu2 .menu-item');
									let selectedValue2 = null;
									menuItems2.forEach(item => {
										item.addEventListener('click', () => {
											// 取消之前選中的選項
											if (selectedValue2) {
												document.querySelector(`.menu2 [data-value="${selectedValue2}"]`).classList.remove('active');
											}
											// 設置當前選中的選項
											item.classList.add('active');
											selectedValue2 = item.dataset.value;
										});
									});

									//"角色沒有的功能"選單 點選效果
									const menuItems3 = document.querySelectorAll('.menu3 .menu-item');
									let selectedValue3 = null;
									menuItems3.forEach(item => {
										item.addEventListener('click', () => {
											// 取消之前選中的選項
											if (selectedValue3) {
												document.querySelector(`.menu3 [data-value="${selectedValue3}"]`).classList.remove('active');
											}
											item.classList.add('active');
											selectedValue3 = item.dataset.value;
										});
									})
								})
							}).catch(error => console.error(error));
				})
			}).catch(error => console.error("Error:", error));
		}else {
			swal("更改失敗!", "請先點選要調整權限的角色以及角色擁有的功能!", "error");
		}
	})

	//角色功能新增
	$(".addfunc").click(() => {
		selectedRoleno = $(".role-menu.active").data("value");//抓到正在被點選的角色(roleno)
		selectedNoFunc = $(".nofuncs.active").attr("id");//抓到正在被點選的角色 沒有的功能(funcno)
		const addRoleauth = {
			roleno: selectedRoleno,
			funcno: selectedNoFunc
		}
		if ($(".role-menu.active").length && $(".nofuncs.active").length) {
			fetch("/roleauthority/addRoleauthority", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(addRoleauth)
			}).then(success => {
				swal("新增成功!", "您已經為角色新增了功能!", "success")
					.then(() => {   // 清空func相關的div 重載資料
						$(".menu2").empty();
						$(".menu3").empty();
						fetch("role/garf")
							.then(response => response.json())
							.then(roleData2 => {
								roleData2.forEach(role2 => {
									console.log(selectedRoleno);//test是否接的到被選中的角色的value
									if (`${role2.roleno}` === `${selectedRoleno}`) {
										//該角色有的功能
										const funcSet = new Set();
										for (let func in role2.funcs) {
											funcSet.add(`${func}: ${role2.funcs[func]}`);
										}
										const funclist = Array.from(funcSet);
										for (let func of funclist) {
											$(".menu2").html(function (i, html) {
												return html + `<div class="menu-item hasfuncs" id="${func.split(':')[0]}" data-value="funcno-${func.split(':')[0]}">${func.split(':')[1]}</div>`;
											});
											// console.log(func); //test 顯示角色全部擁有的功能
										}
										//該角色沒有的功能
										const missfuncSet = new Set();
										for (let missfunc in role2.nofuncs) {
											missfuncSet.add(`${missfunc}: ${role2.nofuncs[missfunc]}`)
										}
										const nofunclist = Array.from(missfuncSet);
										for (let missfunc of nofunclist) {
											$(".menu3").html(function (i, html) {
												return html + `<div class="menu-item nofuncs" id="${missfunc.split(':')[0]}" data-value="funcno-${missfunc.split(':')[0]}">${missfunc.split(':')[1]}</div>`;
											});
											// console.log(missfunc); //test 顯示角色全部沒有的功能
										}
									} 
									//"角色擁有權限"選單  點選效果
									const menuItems2 = document.querySelectorAll('.menu2 .menu-item');
									let selectedValue2 = null;
									menuItems2.forEach(item => {
										item.addEventListener('click', () => {
											// 取消之前選中的選項
											if (selectedValue2) {
												document.querySelector(`.menu2 [data-value="${selectedValue2}"]`).classList.remove('active');
											}
											// 設置當前選中的選項
											item.classList.add('active');
											selectedValue2 = item.dataset.value;
										});
									});

									//"角色沒有的功能"選單 點選效果
									const menuItems3 = document.querySelectorAll('.menu3 .menu-item');
									let selectedValue3 = null;
									menuItems3.forEach(item => {
										item.addEventListener('click', () => {
											// 取消之前選中的選項
											if (selectedValue3) {
												document.querySelector(`.menu3 [data-value="${selectedValue3}"]`).classList.remove('active');
											}
											// 設置當前選中的選項
											item.classList.add('active');
											selectedValue3 = item.dataset.value;
										});
									})
								})
							}).catch(error => console.error(error));
					})
			}).catch(error => console.error("Error:", error));
		} else {
			swal("更改失敗!", "請先點選要調整權限的角色以及角色還未有的功能!", "error");
		}
	})

	// -------------------------點選權限功能設定/後台使用者button監聽器------------------------------------------------
	// 當點選權限功能設定的button時，修改最後一個button的屬性和內容
	document.querySelector('.func-set').addEventListener('click', function () {
		document.querySelector('.changebutton').setAttribute('data-bs-target', '#inviteTeamModal2');
		document.querySelector('.changebutton').textContent = '新增後台角色';
		document.querySelector('.hide').setAttribute('hidden', 'hidden');
		document.querySelector('.hide2').setAttribute('hidden', 'hidden');
	});

	// 當點選回後台使用者的button時，恢復最後一個button的原本屬性和內容
	document.querySelector('.back-user').addEventListener('click', function () {
		document.querySelector('.changebutton').setAttribute('data-bs-target', '#inviteTeamModal');
		document.querySelector('.changebutton').textContent = '新增後台使用者';
		document.querySelector('.hide').removeAttribute('hidden', 'hidden');
		document.querySelector('.hide2').removeAttribute('hidden', 'hidden');
	});
	//--------------------------新增後台角色--------------------------------------------------
	$("#addNewRole").click(() => {
		const addNewRole = {
			rolename: $("#rolename").val(),
			rolestatus: $('input[name="rolestatus"]:checked').val()
		}
		fetch("role/addNewRole", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify(addNewRole)
		}).then(success => {
			swal("新增成功!", "您已經新增了一個職位角色,請為您的角色加上功能!", "success")
				.then(() => {   //清空value 執行cancel  清空div 重載資料
					$("#rolename").val("");
					$("#roleCancel").click();
					$(".menu4").empty();
					$(".menu1").empty();
					$(".menu2").empty();
					$(".menu3").empty();
					refreshRoleData();
				})
		}).catch(error => console.error("Error:", error));
	})
	// ------------------------以下為透過fetchAPI拿取資料後的功能製作-----------------------------------------------------
	const selectElement = document.querySelector('.sp');//為了要監聽啟用停用選單
	fetch('backuser/ga')
		.then(response => response.json())
		.then(data => {
			const table = document.querySelector('.table tbody');
			data.forEach(backuser => {
				const tr = document.createElement('tr');
				//根據啟用/停用選單的value顯示表格內容
				function showBackuser() {
					const option = selectElement.options[selectElement.selectedIndex];
					const selectValue = option.value;    //權限狀態的選單的value
					//↓以下為改變停用選單的th內容改成啟用
					const auth = document.querySelector("#auth");
					if (selectValue === "0") {
						auth.textContent = "啟用";
					} else {
						auth.textContent = "停權";
					}
					if (selectValue === `${backuser.bastatus}`) {
						tr.innerHTML = `
							<td>${backuser.baaccount}</td>
							<td><input type="text" class="name allInput" id="${backuser.baname}" value="${backuser.baname}" readonly></td>
							<td><input class="backuser allInput" id="email-${backuser.bano}" value="${backuser.baemail}" readonly></td>
							<td>
							<select class="jobSelect allInput" id="mySelect-${backuser.baaccount}">
							</select>
							<input data-bs-toggle="modal" data-bs-target="#itm"
								type="image" data-id="1" id="mySelect-${backuser.bano}" class="iconbutton" img
								src="images/iconnnnnnnnn.png">
							</td>
							<td><input class="phone allInput" id="${backuser.bacell}" value="${backuser.bacell}" readonly></td>
							<td>
							<input type="image" id ="myEdit-${backuser.bano}" class="editbutton" img
								src="images/edit.png">
							</td>
							<td><span class="action-btn" id="myAuth-${backuser.bano}" ><i class="fa-solid fa-lock"></i></span></td>
						`;
						table.appendChild(tr);
						//根據角色 數量 產生相對應的 select 選項-------------------------------------------------------------
						fetch('role/garf')
							.then(response => response.json())
							.then(roleData => {
								const select = document.getElementById(`mySelect-${backuser.baaccount}`);
								roleData.forEach(role => {
									const option = document.createElement('option');
									option.value = role.roleno;
									option.text = role.rolename;
									option.selected = backuser.baroleno === role.roleno;
									select.appendChild(option);
									// 角色選單 print 到 瀏覽功能頁
									const iconbutton = document.querySelector(`#mySelect-${backuser.bano}`);//特定backuser旁功能瀏覽按鈕
									const currentRole = document.querySelector('#currentRole'); //選取器選取  要放內容(角色名稱)的地方
									const workAuthority = document.querySelector('#workAuthority'); //選取器選取  要放內容(負責權限名稱)的地方
									iconbutton.addEventListener('click', () => {
										if (backuser.baroleno === role.roleno) {
											currentRole.textContent = `${role.rolename}`;
											workAuthority.innerHTML = "";   //重新點擊button清空再印出
											for (let func in role.funcs) {
												workAuthority.innerHTML += `${role.funcs[func]}<br>`;
											}
										}
									})
								});
								select.disabled = true; //關閉編輯選單
							}).catch(error => console.error(error));
						// ↓這邊是在做編輯按鈕-------------------------------------------------------------------------------------------
						const editbutton = document.querySelector(`#myEdit-${backuser.bano}`);//backuser專屬的編輯按鈕抓取
						const select = document.getElementById(`mySelect-${backuser.baaccount}`);
						const baname = document.getElementById(`${backuser.baname}`);
						const baemail = document.getElementById(`email-${backuser.bano}`);
						const bacell = document.getElementById(`${backuser.bacell}`);
						editbutton.addEventListener('click', () => {

							if (select.disabled) {
								select.disabled = false;
								baname.removeAttribute("readonly");
								baname.className = "name";
								baemail.removeAttribute("readonly");
								baemail.className = "backuser";
								bacell.removeAttribute("readonly");
								bacell.className = "phone";

							} else {
								select.disabled = true;
								baname.setAttribute("readonly", "readonly");
								baname.className = "name allInput";
								baemail.setAttribute("readonly", "readonly");
								baemail.className = "backuser allInput";
								bacell.setAttribute("readonly", "readonly");
								bacell.className = "phone allInput";

								// 這邊寫fetch儲存編輯後的資料
								const updateBu = {
									bano: backuser.bano,
									baaccount: backuser.baaccount,
									baname: $(`#${backuser.baname}`).val(),
									baemail: $(`#email-${backuser.bano}`).val(),
									baroleno: $(`#mySelect-${backuser.baaccount}`).val(),
									bacell: $(`#${backuser.bacell}`).val(),
									bastatus: backuser.bastatus,
								}
								fetch(`/backuser/${backuser.bano}`, {
									method: "POST",
									headers: { "Content-Type": "application/json" },
									body: JSON.stringify(updateBu)
								}).then(response => response.json())
									.then(success => {
										swal("修改成功!", "您已經更改了會員資料了", "success")
											.then(() => { location.reload(); })
									}).catch(error => console.error("Error:", error));

							}
						})
						//↓這邊是在做權限按鈕-------------------------------------------------------------------------------------------
						const authbutton = document.getElementById(`myAuth-${backuser.bano}`);
						authbutton.addEventListener("click", () => {
							fetch(`backuser/${backuser.bano}/auth`, {
								method: "POST"
							}).then(response => response.json())
								.then(success => {
									if (`${backuser.bastatus}` === "1") {
										swal("停權成功!", "您已經更改了會員的權限資料了", "warning")
											.then(() => {
												backuser.bastatus = 0;
												tr.remove();
											})
									} else {
										swal("啟用成功!", "您已經更改了會員的權限資料了", "success")
											.then(() => {
												backuser.bastatus = 1;
												tr.remove();
											})
									}

								}).catch(error => console.error("Error:", error));
						})



					}
				}
				// ----------------------------------------------------------------------------------------------------------------------------
				showBackuser(); //讓打開網頁一開始先顯示啟用帳號的表格內容
				//再根據啟用/停用選單,改變表格內容(對選單做監聽器)
				selectElement.addEventListener('change', () => {
					tr.remove();
					showBackuser();
				});
			});
		}).catch(error => console.error(error));

	//新增後台成員
	$("#inviteNewBu").click(() => {
		const newBu = {
			baname: $("#baname").val(),
			baaccount: $("#baaccount").val(),
			baemail: $("#baemail").val(),
			bacell: $("#bacell").val(),
			bapassword: $("#bapassword").val(),
			baroleno: $("#baroleno").val(),
			bastatus: "1"
		}
		fetch("backuser/insertBu", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify(newBu)
		}).then(success => {
			swal("新增成功!", "您已經新增了一位成員至團隊中!", "success")
				.then(() => {
					location.reload();
				})
		})
			.catch(error => console.error("Error:", error));
	})


	// 當輸入框改變時觸發搜尋
	$("#search").keyup(function () {
		var searchValue = $("#search").val().toLowerCase();
		$("tbody tr").filter(function () {
			//這邊filter會篩選所有value跟searchValue相符合的input
			var trInputValue = $(this).find("input").filter(function () {
				return $(this).val().toLowerCase().indexOf(searchValue) > -1;  
			});

			// 如果tr底下 所有文字內容有跟searchValue相符合,textMatches 就會等於 true
			var trText = $(this).text().toLowerCase().indexOf(searchValue) > -1;
			
			// 如果有符合條件的input會顯示true,不符合就為false,  toggle(true)→顯示  toggle(false)→隱藏
			$(this).toggle(trInputValue.length > 0 || trText);
		});
	});

</script>

</html>