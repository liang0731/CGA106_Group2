<!DOCTYPE html>
<html lang="en" class="h-100">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, shrink-to-fit=9">
    <meta name="description" content="Gambolthemes">
    <meta name="author" content="Gambolthemes">
    <title>Barren - Simple Online Event Ticketing System</title>

    <!-- Favicon Icon -->
    <link rel="icon" type="image/png" href="images/fav.png">

    <!-- Stylesheets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
            href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
            rel="stylesheet">
    <link href='vendor/unicons-2.0.1/css/unicons.css' rel='stylesheet'>
    <link href="css/style.css" rel="stylesheet">
    <link href="css/responsive.css" rel="stylesheet">
    <link href="css/night-mode.css" rel="stylesheet">

    <!-- Vendor Stylesheets -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="vendor/OwlCarousel/assets/owl.carousel.css" rel="stylesheet">
    <link href="vendor/OwlCarousel/assets/owl.theme.default.min.css" rel="stylesheet">
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="vendor/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">

    <script
            src="https://code.jquery.com/jquery-3.6.0.js"
            integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
            crossorigin="anonymous"></script>

    <style>
        /* (A) SEAT & "COLOR CODE" */
        .seat, .statusBtn {
            width: 75px;
            height: 75px;
            padding: 10px;
            border-radius: 10px;
            background: white;
            font-size: 8px;
            text-align: center;
            line-height: 27.5px
        }

        .banned {
            background: white;
            color: lightgray;
        }

        .toSell {
            background: lightgreen;
            color: black;
        }

        .taken {
            background: #df0000;
            color: #fff;
        }

        .selected {
            background: #c7c5c5;
            color: black;
        }

        .beLocked {
            background: lightblue;
            color: black;
        }

        /* (B) SEATS LAYOUT */
        #layout {
            max-width: 1000px;
            display: grid;
            grid-gap: 10px;
            margin-bottom: 20px;
            overflow: auto;
        }

        /* (C) LEGEND */
        #legend {
            width: 100%;
            display: inline-block;
            margin-bottom: 7px;
        }

        #legend button {
            border: none;
        }

        #legend .txt {
            display: flex;
            align-items: center;
        }


        /* (D) SAVE */
        /* #save {
            font-size: 20px;
            margin-top: 20px;
            padding: 10px 20px;
            border: 0;
            color: #fff;
            background: #00479f;
        } */

        body {
            min-width: 745px;
        }
    </style>
</head>

<body class="d-flex flex-column h-100">
<!-- Header Start-->
<header class="header">
    <div class="header-inner">
        <nav
                class="navbar navbar-expand-lg bg-barren barren-head navbar fixed-top justify-content-sm-start pt-0 pb-0">
            <div class="container">
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
						<span class="navbar-toggler-icon">
							<i class="fa-solid fa-bars"></i>
						</span>
                </button>
                <a class="navbar-brand order-1 order-lg-0 ml-lg-0 ml-2 me-auto" href="index.html">
                    <div class="res-main-logo">
                        <img src="images/logo-icon.svg" alt="">
                    </div>
                    <div class="main-logo" id="logo">
                        <img src="images/logo.svg" alt="">
                        <img class="logo-inverse" src="images/dark-logo.svg" alt="">
                    </div>
                </a>
                <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar"
                     aria-labelledby="offcanvasNavbarLabel">
                    <div class="offcanvas-header">
                        <div class="offcanvas-logo" id="offcanvasNavbarLabel">
                            <img src="images/logo-icon.svg" alt="">
                        </div>
                        <button type="button" class="close-btn" data-bs-dismiss="offcanvas" aria-label="Close">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="offcanvas-body">
                        <div class="offcanvas-top-area">
                            <div class="create-bg">
                                <a href="create.html" class="offcanvas-create-btn">
                                    <i class="fa-solid fa-calendar-days"></i>
                                    <span>Create Event</span>
                                </a>
                            </div>
                        </div>
                        <ul class="navbar-nav justify-content-end flex-grow-1 pe_5">
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="index.html">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    Explore Events
                                </a>
                                <ul class="dropdown-menu dropdown-submenu">
                                    <li><a class="dropdown-item" href="explore_events.html">Explore Events</a></li>
                                    <li><a class="dropdown-item" href="venue_event_detail_view.html">Venue Event
                                        Detail View</a></li>
                                    <li><a class="dropdown-item" href="online_event_detail_view.html">Online Event
                                        Detail View</a></li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="pricing.html">Pricing</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    Blog
                                </a>
                                <ul class="dropdown-menu dropdown-submenu">
                                    <li><a class="dropdown-item" href="our_blog.html">Our Blog</a></li>
                                    <li><a class="dropdown-item" href="blog_detail_view.html">Blog Detail View</a>
                                    </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    Help
                                </a>
                                <ul class="dropdown-menu dropdown-submenu">
                                    <li><a class="dropdown-item" href="faq.html">FAQ</a></li>
                                    <li><a class="dropdown-item" href="help_center.html">Help Center</a></li>
                                    <li><a class="dropdown-item" href="contact_us.html">Contact Us</a></li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    Pages
                                </a>
                                <ul class="dropdown-menu dropdown-submenu">
                                    <li>
                                        <a class="dropdown-item submenu-item" href="#">Other Pages</a>
                                        <ul class="submenu dropdown-menu">
                                            <li><a class="dropdown-item pe-5" href="sign_in.html">Sign In</a></li>
                                            <li><a class="dropdown-item pe-5" href="sign_up.html">Sign Up</a></li>
                                            <li><a class="dropdown-item pe-5" href="forgot_password.html">Forgot
                                                Password</a></li>
                                            <li><a class="dropdown-item pe-5" href="about_us.html">About Us</a></li>
                                            <li><a class="dropdown-item pe-5" href="checkout.html">Checkout</a></li>
                                            <li><a class="dropdown-item pe-5" href="checkout_premium.html">Checkout
                                                Premium</a></li>
                                            <li><a class="dropdown-item pe-5" href="invoice.html">Invoice</a></li>
                                            <li><a class="dropdown-item pe-5" href="coming_soon.html">Coming
                                                Soon</a></li>
                                            <li><a class="dropdown-item pe-5" href="error_404.html">Error 404</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li>
                                        <a class="dropdown-item submenu-item" href="#">Create Event</a>
                                        <ul class="submenu dropdown-menu">
                                            <li><a class="dropdown-item pe-5" href="create.html">Create</a></li>
                                            <li><a class="dropdown-item pe-5" href="create_venue_event.html">Create
                                                Venue Event</a></li>
                                            <li><a class="dropdown-item pe-5" href="create_online_event.html">Create
                                                Online Event</a></li>
                                        </ul>
                                    </li>
                                    <li>
                                        <a class="dropdown-item submenu-item" href="#">Events View</a>
                                        <ul class="submenu dropdown-menu">
                                            <li><a class="dropdown-item pe-5"
                                                   href="online_event_detail_view.html">Online Event Detail
                                                View</a></li>
                                            <li><a class="dropdown-item pe-5"
                                                   href="venue_event_detail_view.html">Venue Event Detail View</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="dropdown-item" href="booking_confirmed.html">Booking Confirmed</a>
                                    </li>
                                    <li><a class="dropdown-item" href="attendee_profile_view.html">Attendee Profile
                                        View</a></li>
                                    <li><a class="dropdown-item" href="organiser_profile_view.html">Organiser
                                        Profile View</a></li>
                                    <li><a class="dropdown-item" href="my_organisation_dashboard.html">Organization
                                        Dashboard</a></li>
                                    <li><a class="dropdown-item" href="sell_tickets_online.html">Sell Tickets
                                        Online</a></li>
                                    <li><a class="dropdown-item" href="refer_a_friend.html">Refer a Friend</a></li>
                                    <li><a class="dropdown-item" href="term_and_conditions.html">Terms &
                                        Conditions</a></li>
                                    <li><a class="dropdown-item" href="privacy_policy.html">Privacy Policy</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div class="offcanvas-footer">
                        <div class="offcanvas-social">
                            <h5>Follow Us</h5>
                            <ul class="social-links">
                                <li><a href="#" class="social-link"><i class="fab fa-facebook-square"></i></a>
                                <li><a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                                <li><a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                                <li><a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
                                <li><a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="right-header order-2">
                    <ul class="align-self-stretch">
                        <li>
                            <a href="create.html" class="create-btn btn-hover">
                                <i class="fa-solid fa-calendar-days"></i>
                                <span>Create Event</span>
                            </a>
                        </li>
                        <li class="dropdown account-dropdown">
                            <a href="#" class="account-link" role="button" id="accountClick"
                               data-bs-auto-close="outside" data-bs-toggle="dropdown" aria-expanded="false">
                                <img src="images/profile-imgs/img-13.jpg" alt="">
                                <i class="fas fa-caret-down arrow-icon"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-account dropdown-menu-end"
                                aria-labelledby="accountClick">
                                <li>
                                    <div class="dropdown-account-header">
                                        <div class="account-holder-avatar">
                                            <img src="images/profile-imgs/img-13.jpg" alt="">
                                        </div>
                                        <h5>John Doe</h5>
                                        <p>johndoe@example.com</p>
                                    </div>
                                </li>
                                <li class="profile-link">
                                    <a href="my_organisation_dashboard.html" class="link-item">My Organisation</a>
                                    <a href="organiser_profile_view.html" class="link-item">My Profile</a>
                                    <a href="sign_in.html" class="link-item">Sign Out</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <div class="night_mode_switch__btn">
                                <div id="night-mode" class="fas fa-moon fa-sun"></div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="overlay"></div>
    </div>
</header>
<!-- Header End-->
<!-- Body Start-->

<!-- 人工選位開始 -->
<div class="modal fade" id="orgSettings" tabindex="-1" aria-labelledby="addorganisationLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="blockName" class="modal-title"></h5>
                <button type="button" class="close-model-btn" data-bs-dismiss="modal" aria-label="Close"
                        onclick="seatsmgt.cancel()"><i
                        class="uil uil-multiply"></i></button>
            </div>
            <!-- 這邊加上座位狀態選擇器 -->
            <div id="legend" style="display: flex; padding: 5px!important;">
                <div style="margin: 18px 18px 18px 18px; padding-top: 10px; position: relative; right: 0;">
                    <div class="form-group">
                        <label for="quantity">選擇張數：</label>
                        <select class="form-control" id="quantity">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                </div>
                <div style="margin: 20px 20px 20px 0px;">
                    <button class="statusBtn toSell" style="margin: 5px;" disabled>可選位</button>
                    <button class="statusBtn taken" style="margin: 5px;" disabled>已售出</button>
                    <button class="statusBtn beLocked" style="margin: 5px;" disabled>鎖定中</button>
                    <button class="statusBtn selected" style="margin: 5px;" disabled>已選擇</button>
                </div>
                <div style="margin: 35px 0px; position: relative; right: 0;">
                    <form action="">
                        <button type="submit" class="main-btn btn-hover"
                                style="background-color: gray;" onclick="seatsmgt.cancel();">重設選位
                        </button>
                        <button type="submit" class="main-btn btn-hover"
                                onclick="seatsmgt.save()">確定選位
                        </button>
                    </form>
                </div>
            </div>
            <!-- (A) SEAT LAYOUT -->
            <div class="d-md-flex flex-wrap align-items-center" style="padding: 10px!important;">
                <div id="layout" style="margin: auto;" style="overflow:scroll-y"></div>
            </div>
        </div>
    </div>
</div>
<!-- 人工選位結束-->

<!-- 電腦選位開始 -->


<div class="modal fade" id="orgSettings_system" tabindex="-1" aria-labelledby="addorganisationLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blockName_system"></h5>
                <button type="button" class="close-model-btn" data-bs-dismiss="modal" aria-label="Close"><i
                        class="uil uil-multiply"></i></button>
            </div>
            <div class="modal-body">
                <div class="model-content main-form">
                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group main-form mt-4">
                                <input id="blockNo" type="hidden" value="">
                                <label class="form-label">選擇張數</label>
                                <select id="ticketDecr" class="form-control" data-size="5" title="Nothing selected"
                                        data-live-search="true" >
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group mt-4">
                                <label class="form-label" style="color: red!important;">* 注意事項</label>
                                <input class="form-control h_40" type="text" placeholder="" value="一次購票僅限四張"
                                       style="color: red!important; background-color: transparent!important; border: none!important;">
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group mt-4">
                                <label class="form-label">請輸入驗證碼</label>
                                <input class="form-control h_40" type="text" placeholder="" value="">
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group mt-4">
                                <label class="form-label">驗證碼</label>
                                <input class="form-control h_40" type="text" placeholder="" value="fj21fd" disabled
                                       style="background-color: lightgray!important; color: black!important;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="main-btn min-width btn-hover h_40" data-bs-dismiss="modal"
                        onclick="TicketBySystem()">確定選位
                </button>
            </div>
        </div>
    </div>
</div>
<!-- 電腦選位結束-->

<div class="wrapper">
    <div class="breadcrumb-block">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-md-10">
                    <div class="barren-breadcrumb">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                                <li class="breadcrumb-item"><a href="explore_events.html">Explore Events</a>
                                </li>
                                <li class="breadcrumb-item"><a href="online_event_detail_view.html">Online Event
                                    Detail View</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="event-dt-block p-80">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-md-12">
                    <div class="main-title checkout-title">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group main-form mt-4">
                                請選擇場次：
                                <select id="selectSession" class="form-control" data-size="5" data-live-search="true"
                                        onchange="selectSession()">
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-8 col-lg-12 col-md-12" style="position: relative;">
                    <div class="checkout-block" style="position: sticky; top: 0;">
                        <div class="main-card">
                            <div class="bp-content bp-form">
                                <img id="seatsImg" src="" alt="" style="max-width: 100%; ">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-lg-12 col-md-12">
                    <div class="main-card order-summary">
                        <div class="order-summary-content p_30">
                            <div class="event-order-dt">
                                <div class="event-thumbnail-img">
                                    <img id="actImg" src="" alt="" style="max-width: 100%">
                                </div>
                                <div class="event-order-dt-content">
                                    <h5 id="actName"></h5>
                                    <span id="showTime"></span>
                                </div>
                            </div>
                            <div class="order-total-block">
                                請選擇選位方式
                                <div class="nav custom2-tabs btn-group" role="tablist">
                                    <button id="byComputor" class="tab-link active" data-bs-toggle="tab"
                                            data-bs-target=""
                                            type="button" role="tab" aria-controls="" aria-selected="true"
                                            style="width: 49%;" onclick="selectBySystem()">電腦選位
                                    </button>
                                    <button id="byMember" class="tab-link" data-bs-toggle="tab" data-bs-target=""
                                            type="button" role="tab" aria-controls="" aria-selected="false"
                                            style="width: 49%;" onclick="selectByMember()">自行選位
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="order-summary-content p_30">
                            <div class="form-group mt-4">
                                <label class="form-label">請選擇區域</label>
                                <div id="selectBlocks">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- Body End-->
<!-- Footer Start-->
<footer class="footer mt-auto">
    <div class="footer-top">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="footer-content">
                        <h4>Company</h4>
                        <ul class="footer-link-list">
                            <li><a href="about_us.html" class="footer-link">About Us</a></li>
                            <li><a href="help_center.html" class="footer-link">Help Center</a></li>
                            <li><a href="faq.html" class="footer-link">FAQ</a></li>
                            <li><a href="contact_us.html" class="footer-link">Contact Us</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-content">
                        <h4>Useful Links</h4>
                        <ul class="footer-link-list">
                            <li><a href="create.html" class="footer-link">Create Event</a></li>
                            <li><a href="sell_tickets_online.html" class="footer-link">Sell Tickets Online</a></li>
                            <li><a href="privacy_policy.html" class="footer-link">Privacy Policy</a></li>
                            <li><a href="term_and_conditions.html" class="footer-link">Terms & Conditions</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-content">
                        <h4>Resources</h4>
                        <ul class="footer-link-list">
                            <li><a href="pricing.html" class="footer-link">Pricing</a></li>
                            <li><a href="our_blog.html" class="footer-link">Blog</a></li>
                            <li><a href="refer_a_friend.html" class="footer-link">Refer a Friend</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-content">
                        <h4>Follow Us</h4>
                        <ul class="social-links">
                            <li><a href="#" class="social-link"><i class="fab fa-facebook-square"></i></a>
                            <li><a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                            <li><a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                            <li><a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
                            <li><a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
                        </ul>
                    </div>
                    <div class="footer-content">
                        <h4>Download Mobile App</h4>
                        <div class="download-app-link">
                            <a href="#" class="download-btn"><img src="images/app-store.png" alt=""></a>
                            <a href="#" class="download-btn"><img src="images/google-play.png" alt=""></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="footer-copyright-text">
                        <p class="mb-0">© 2022, <strong>Barren</strong>. All rights reserved. Powered by
                            Gambolthemes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- Footer End-->

<script src="js/jquery-3.6.0.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="vendor/OwlCarousel/owl.carousel.js"></script>
<script src="vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
<script src="js/custom.js"></script>
<script src="js/night-mode.js"></script>

<!-- 選擇座位的JS -->
<script>
    // WebSocket 用戶相關變數與函式 (connect/ sendMessage/ disconnect)
    let webSocket;

    function connect() {
        let MyPoint = "/SelectSeatsTogether/Sync";
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let endPointURL = "ws://" + window.location.host + webCtx + MyPoint;

        // 建立 WebSocket 連線
        webSocket = new WebSocket(endPointURL);

        // WebSocket 啟動動作
        webSocket.onopen = function (event) {
        };

        // WebSocket 接收推播動作
        webSocket.onmessage = function (event) {
            let jsonObj = JSON.parse(event.data);
            let seat = document.getElementById(`${jsonObj.seatNo}`);

            if (jsonObj.seatStatus == 3) {
                seat.classList.remove("toSell");
                seat.classList.add("beLocked");
            } else {
                seat.classList.remove("beLocked");
                seat.classList.add("toSell");
            }
        };

        // WebSocket 結束使用動作
        webSocket.onclose = function (event) {
        };
    }

    // WebSocket Client 向 Server 端發動訊息的動作
    function sendMessage(seat) {
        let jsonObj;
        if (seat.classList.contains("selected")) {
            jsonObj = {
                "sessionNo": sessionStorage.getItem("sessionNo"),
                "seatNo": seat.id,
                "seatStatus": 3
            };
            fetch("seats/updateSeatStatus" + `?seatStatus=${jsonObj.seatStatus}&seatNo=${jsonObj.seatNo}&sessionNo=${jsonObj.sessionNo}`);
        } else {
            jsonObj = {
                "sessionNo": sessionStorage.getItem("sessionNo"),
                "seatNo": seat.id,
                "seatStatus": 1
            };
            fetch("seats/updateSeatStatus" + `?seatStatus=${jsonObj.seatStatus}&seatNo=${jsonObj.seatNo}&sessionNo=${jsonObj.sessionNo}`);
        }
        webSocket.send(JSON.stringify(jsonObj));
    }

    function disconnect() {
        webSocket.close();
    }

    // 測試用: 假設會員已登入
    sessionStorage.setItem("memberNo", "85341");

    // 選位相關變數與函式
    let seats;
    let t_seats;
    let t_Row;
    let t_Column;
    let count;
    let lockedSeats = [];
    let layout = document.getElementById("layout");

    let seatsmgt = {

        init: () => {
            layout.innerHTML = "";

            // 初始化票券數量 (最小為 1 張)
            $('#quantity').val("1");

            // 初始化已選位數量
            count = 0;

            $.ajax({ // 取得場次所選擇區域的座位表 (MySQL)
                async: false,
                type: 'GET',
                url: '/seats/BySessionAndBlock' + `?sessionNo=${sessionStorage.getItem("sessionNo")}&blockNo=${sessionStorage.getItem("blockNo")}`,
                dataType: "json",
                success: function (jsondata) {
                    seats = jsondata;
                }
            });

            t_seats = seats.length;
            t_Row = seats[seats.length - 1].x;
            t_Column = seats[seats.length - 1].y;

            $('#blockName').text(seats[0].blockName);

            // 購買數量 < 選擇數量時，要求更新購買數量
            $('#quantity').change(function () {
                    if ($('#quantity').val() < count)
                        alert("選擇座位數量已超出選購數量，請再次確認!!");
                }
            );

            // 座位每 x 個換一排
            layout.setAttribute("style", `grid-template-columns: repeat(${(t_Column + 1) * 2}, 1fr)`)

            // GENERATE SEATS
            for (let i = 0; i <= t_Row; i++) {
                for (let j = 0; j <= t_Column; j++) {
                    let seat = document.createElement("div");

                    // ID 為座位編號(seatno)
                    seat.id = seats[i * 10 + j].seatNo;

                    seat.innerHTML = `
						第 <span>${seats[i * 10 + j].realX}</span> 排<br>
						第 <span>${seats[i * 10 + j].realY}</span> 位
						`;

                    seat.className = "seat";
                    seat.onclick = () => seatsmgt.toggle(seat);

                    let seatStatus = seats[i * 10 + j].seatStatus;

                    if (!lockedSeats.includes(String(seat.id))) {
                        switch (seatStatus) {
                            case (-1):
                                seat.classList.add("banned");
                                break;
                            case (0):
                                seat.classList.add("taken");
                                break;
                            case (1):
                                seat.classList.add("toSell");
                                break;
                            case (2):
                                seat.classList.add("taken");
                                break;
                        }
                    } else {
                        seat.classList.add("beLocked");
                    }

                    layout.appendChild(seat);

                    // 此行若不加，則座位表會跑版
                    layout.appendChild(document.createElement("br"));
                }
            }
        },

        toggle: seat => {

            if ($('#quantity').val() < count) {
                --count;
                seat.classList.remove("selected");
                seat.classList.add("toSell");
                sendMessage(seat);
            }

            if (seat.classList.contains("toSell")) {
                if ($('#quantity').val() > count) {
                    ++count;
                    seat.classList.remove("toSell");
                    seat.classList.add("selected");
                    sendMessage(seat);
                }
                return;
            }

            if (seat.classList.contains("selected")) {
                if ($('#quantity').val() >= count) {
                    --count;
                    seat.classList.remove("selected");
                    seat.classList.add("toSell");
                    sendMessage(seat);
                }
                return;
            }
        },

        save: () => {
            let seats = document.querySelectorAll("#layout div.selected");
            let seatNos = [];

            for (let s of seats) {
                seatNos.push(s.id);
            }

            sessionStorage.setItem("toBuySeats", JSON.stringify(seatNos));
            window.location.href = "/front-activity-checkout.html";
        },

        cancel: () => {
            // 重設選擇票券數量
            count = 0;
            let seats = document.querySelectorAll("#layout div.selected");
            for (let s of seats) {
                s.classList.remove("selected");
                s.classList.add("toSell");
                sendMessage(s);
            }
        }
    };

    // 取得場次的擁有座位的區域
    let blockHasSeats;

    $.ajax({
        async: false,
        type: 'GET',
        url: '/seats/getBlockHasSeats' + `?actNo=${sessionStorage.getItem("activityNo")}`,
        dataType: "json",
        success: function (jsondata) {
            blockHasSeats = jsondata;
        }
    });

    // 頁面載入動作
    $(document).ready(function () {
        // WebSocket 連線
        connect();

        // 清空下拉選單(selectSession)/ 按鈕(selectBlocks)/ 節目名稱及表演時間
        document.getElementById('selectSession').innerHTML = "";
        document.getElementById('actName').innerText = "";
        document.getElementById('showTime').innerText = "";

        // 取得場次資訊並加入下拉選單
        fetch("Session/ActSessions" + `?actNo=${sessionStorage.getItem("activityNo")}`)
            .then(resp => resp.json())
            .then(jsondata => {
                for (let j of jsondata) {
                    if (j.sessionNo == sessionStorage.getItem("sessionNo")) {
                        document.getElementById('selectSession').innerHTML += `
                            <option value="${j.sessionNo}" selected>${j.sessionsTime} ${j.activity.aname}</option>
                            `;

                        document.getElementById('actName').innerText = `${j.activity.aname}`;

                        document.getElementById('showTime').innerText = `${j.sessionsTime}`;

                    } else {
                        document.getElementById('selectSession').innerHTML += `
                            <option value="${j.sessionNo}">${j.sessionsTime} ${j.activity.aname}</option>
                            `;
                    }
                }
            })

        // 取得節目主視覺、座位圖並呈現於 HTML
        fetch("/Activity/findByActNo" + `?actNo=${sessionStorage.getItem("activityNo")}`)
            .then(resp => resp.json())
            .then(jsondata => {
                document.getElementById('seatsImg').src = `data:image/png;base64,${jsondata.aseatsImg}`;

                let showpic = jsondata.aimgt;

                for (let i = 0; i < showpic.length; i++) {
                    if (showpic[i].aimgMain == 1) {
                        document.getElementById('actImg').src = `data:image/png;base64,${showpic[i].aimg}`;
                    }
                }
            })

        // 預設為系統選位
        selectBySystem();

        // 每秒得到最新的 Redis 座位狀態
        setInterval('getLastestLockedSeats();', 1000);
    })

    // 選擇場次後重新整理 HTML
    function selectSession() {
        sessionStorage.setItem("sessionNo", `${$("#selectSession").val()}`);
        window.location.reload();
    }

    // 點選系統選位按鈕時，將按鈕的 data-bs-target 改為 "#orgSettings_system"
    function selectBySystem() {
        document.getElementById('selectBlocks').innerHTML = "";

        fetch("BlockPrice/findAll")
            .then(resp => resp.json())
            .then(jsondata => {
                    for (let j of jsondata) {
                        if (j.activityNo == sessionStorage.getItem("activityNo")) {
                            document.getElementById('selectBlocks').innerHTML += `
                                <button name="selectOneBlock" value="${j.blockNo}"
                                    class="main-btn btn-hover h_40 w-100 mt-5" type="button"
                                    data-bs-toggle="modal" data-bs-target="#orgSettings_system"
                                    style="margin: 5px!important; background-color: rgb(230, 230, 107);
											    border: none; font-size: 1rem; color: black;"
                                    onMouseDown="setKV(this.value)" onclick="setBlockNoAndName()">${j.blockName}
                                </button>`;
                        }
                    }

                    if (document.getElementById('selectBlocks').innerHTML === "") {
                        document.getElementById('selectBlocks').innerHTML += `
                                <button name="selectOneBlock" value=""
                                    class="main-btn btn-hover h_40 w-100 mt-5" type="button"
                                    data-bs-toggle="modal" data-bs-target="#orgSettings_system"
                                    style="margin: 5px!important; background-color: rgb(230, 230, 107);
							        border: none; font-size: 1rem; color: black;">
							        立即購票
                                </button>`;
                    }
                }
            )
    }

    // 點選自行選位按鈕時，將按鈕的 data-bs-target 改為 "#orgSettings"，但如果對應區域沒有座位時，依然保持 "#orgSettings_system"
    function selectByMember() {
        document.getElementById('selectBlocks').innerHTML = "";

        fetch("BlockPrice/findAll")
            .then(resp => resp.json())
            .then(jsondata => {
                    for (let j of jsondata) {
                        if (j.activityNo == sessionStorage.getItem("activityNo")) {
                            if (blockHasSeats.includes(j.blockNo)) {
                                document.getElementById('selectBlocks').innerHTML += `
                                <button name="selectOneBlock" value="${j.blockNo}"
                                    class="main-btn btn-hover h_40 w-100 mt-5" type="button"
                                    data-bs-toggle="modal" data-bs-target="#orgSettings"
                                    style="margin: 5px!important; background-color: rgb(230, 230, 107);
											    border: none; font-size: 1rem; color: black;"
                                    onMouseDown="setKV(this.value)" onclick="seatsmgt.init()">${j.blockName}
                                </button>`;
                            } else {
                                document.getElementById('selectBlocks').innerHTML += `
                                <button name="selectOneBlock" value="${j.blockNo}"
                                        class="main-btn btn-hover h_40 w-100 mt-5" type="button"
                                        data-bs-toggle="modal" data-bs-target="#orgSettings_system"
                                        style="margin: 5px!important; background-color: rgb(230, 230, 107);
											    border: none; font-size: 1rem; color: black;"
                                        onMouseDown="setKV(this.value)">${j.blockName}
                                </button>`
                            }
                        }
                    }

                    if (document.getElementById('selectBlocks').innerHTML === "") {
                        document.getElementById('selectBlocks').innerHTML += `
                                <button name="selectOneBlock" value=""
                                    class="main-btn btn-hover h_40 w-100 mt-5" type="button"
                                    data-bs-toggle="modal" data-bs-target="#orgSettings_system"
                                    style="margin: 5px!important; background-color: rgb(230, 230, 107);
							        border: none; font-size: 1rem; color: black;">
							        立即購票
                                </button>`;
                    }
                }
            )
    }


    // 零碎的 JS 函式

    // 點選區塊按鈕後將區塊編號存入 SessionStorage
    function setKV(blockNo) {
        sessionStorage.setItem("blockNo", blockNo);
    }

    // 系統選位的顯示視窗，應顯示對應區域名稱
    function setBlockNoAndName() {
        fetch("/BlockPrice/findById" + `?blockNo=${sessionStorage.getItem("blockNo")}`)
            .then(resp => resp.json())
            .then(jsondata => {
                document.getElementById('blockName_system').innerHTML = "";
                document.getElementById('blockName_system').innerHTML = `${jsondata.blockName}`;
            })
    }

    // 監聽浮動視窗點擊空白 => 清空 Redis 所存的鎖定座位
    $('#orgSettings').on('hidden.bs.modal', function (e) {
        seatsmgt.cancel();
    });

    // 取得最新的 Redis 座位狀態
    function getLastestLockedSeats() {
        $.ajax({
            async: false,
            type: 'GET',
            url: '/seats/getLockedSeatsBySession' + `?sessionNo=${sessionStorage.getItem("sessionNo")}`,
            dataType: "json",
            success: function (jsondata) {
                lockedSeats = jsondata;
            }
        });
    }

    // 系統選位 => 購票
    function TicketBySystem() {
        fetch("/Activity/findByActNo" + `?actNo=${sessionStorage.getItem("activityNo")}`)
            .then(resp => resp.json())
            .then(jsondata => {
                if (jsondata.wetherSeat != 1) { // 若節目完全沒有座位區分，將要購買的票券數量存在 SessionStorage
                    sessionStorage.setItem("toBuyTickets", $('#ticketDecr').val());
                    window.location.href = "/front-activity-checkout.html";
                } else { // 若節目有座位區分，發送請求到後端取得座位陣列
                    fetch("/seats/getTicketsBystem" + `?ticketQTY=${$('#ticketDecr').val()}&blockNo=${sessionStorage.getItem("blockNo")}&sessionNo=${sessionStorage.getItem("sessionNo")}`)
                        .then(resp => resp.json())
                        .then(jsondata => {
                                if (jsondata) {
                                    let seatNos = [];
                                    for (let j of jsondata) {
                                        seatNos.push(j);
                                        // 包裝取得的座位陣列，並送給 WebSocket 伺服器推播
                                        let seat = document.createElement("div");
                                        seat.id = j;
                                        seat.classList.add("selected");
                                        sendMessage(seat);
                                    }

                                    // 將要購買的座位編號以陣列的格式存在 SessionStorage
                                    sessionStorage.setItem("toBuySeats", JSON.stringify(seatNos));
                                    window.location.href = "/front-activity-checkout.html";
                                    return;
                                }

                                alert("無對應數量票券");
                            }
                        )
                }
            })
    }

</script>

</body>

</html>