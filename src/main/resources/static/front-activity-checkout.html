<!DOCTYPE html>
<html lang="en" class="h-100">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, shrink-to-fit=9">
    <meta name="description" content="Gambolthemes">
    <meta name="author" content="Gambolthemes">
    <title>ezTicket - 一站式購票體驗</title>

    <!-- Favicon Icon -->
    <link rel="icon" type="image/png" href="images/ezTicket.png">

    <!-- Stylesheets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
            href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
            rel="stylesheet">
    <link href='vendor/unicons-2.0.1/css/unicons.css' rel='stylesheet'>
    <link href="css/style.css" rel="stylesheet">
    <link href="css/responsive.css" rel="stylesheet">
    <link href="css/night-mode.css" rel="stylesheet">

    <!-- Vendor Stylesheets -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="vendor/OwlCarousel/assets/owl.carousel.css" rel="stylesheet">
    <link href="vendor/OwlCarousel/assets/owl.theme.default.min.css" rel="stylesheet">
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="vendor/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="d-flex flex-column h-100">
   <!-- Header Start-->
   <header class="header">
    <div class="header-inner">
        <nav
            class="navbar navbar-expand-lg bg-barren barren-head navbar fixed-top justify-content-sm-start pt-0 pb-0">
            <div class="container">
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
                    <span class="navbar-toggler-icon">
                        <i class="fa-solid fa-bars"></i>
                    </span>
                </button>
                <a class="navbar-brand order-1 order-lg-0 ml-lg-0 ml-2 me-auto" href="index.html">
                    <div class="res-main-logo">
                        <img src="images/ezTicket-icon.svg" alt="">
                    </div>
                    <div class="main-logo" id="logo">
                        <img src="images/ezTicket.svg" alt="">
                        <img class="logo-inverse" src="images/dark-logo.svg" alt="">
                    </div>
                </a>
                <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar"
                    aria-labelledby="offcanvasNavbarLabel">
                    <div class="offcanvas-header">
                        <div class="offcanvas-logo" id="offcanvasNavbarLabel">
                            <img src="images/ezTicket-icon.svg" alt="">
                        </div>
                        <button type="button" class="close-btn" data-bs-dismiss="offcanvas" aria-label="Close">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="offcanvas-body">
                        <ul class="navbar-nav justify-content-end flex-grow-1 pe_5">
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="front-activity-event-explore_events.html"
                                    style="color:black !important">探索節目</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="front-product-explore_products.html"
                                    style="color:black !important">探索商品</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="#"
                                    style="color:black !important">常見問題</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="#"
                                    style="color:black !important">最新消息</a>
                            </li>

                        </ul>
                    </div>
                </div>
                <div class="right-header order-2">
                    <ul class="align-self-stretch">
                        <li>
                            <a href="front-activity-event-explore_events.html" class="create-btn btn-hover">
                                <i class="fa-solid fa-calendar-days"></i>
                                <span>活動訂票</span>
                            </a>
                            <a href="front-product-explore_products.html" class="create-btn btn-hover">
                                <i class="fa-sharp fa-solid fa-bag-shopping"></i>
                                <span>聯名商品</span>
                            </a>
                        </li>
                        <li>

                        </li>
                        <li class="dropdown account-dropdown">
                            <a href="#" class="account-link" role="button" id="accountClick"
                                data-bs-auto-close="outside" data-bs-toggle="dropdown" aria-expanded="false">
                                <img class="D-mimg" src="images/profile-imgs/img-13.jpg" alt="">
                                <i class="fas fa-caret-down arrow-icon"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-account dropdown-menu-end"
                                aria-labelledby="accountClick">
                                <li>
                                    <div class="dropdown-account-header">
                                        <div class="account-holder-avatar">
                                            <img class="D-mimg" src="images/profile-imgs/img-13.jpg" alt="">
                                        </div>
                                        <h5 class="D-mname">會員名稱</h5>
                                        <p class="D-memail">johndoe@example.com</p>
                                    </div>
                                </li>
                                <li class="profile-link">
                                    <a class="dropdown-item pe-5" href="front-users-member-profile.html">會員資訊</a>
                                    <a class="dropdown-item pe-5" href="front-users-mem-sign-in.html">登入</a>
                                    <a class="dropdown-item pe-5" href="front-users-sign-up.html">註冊</a>
                                    <a class="dropdown-item pe-5" href="front-users-forgot-pwd.html">忘記密碼</a>

                                </li>
                            </ul>
                        </li>
                        <li class="dropdown account-dropdown">
                            <a href="front-product-shopping_cart.html" class="account-link">
                                <div id="cart">
                                    <img src="images/profile-imgs/cart2.jpg">
                                    <span class="badge" style="color:#102743 ;">0</span>
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="overlay"></div>
    </div>
</header>
<!-- Header End-->
<!-- Body Start-->
<div class="wrapper">
    <div class="breadcrumb-block">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-md-10">
                    <div class="barren-breadcrumb">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html">首頁</a></li>
                                <li class="breadcrumb-item"><a href="front-activity-event-explore_events.html">探索活動</a></li>
                                <li class="breadcrumb-item"><a href="#">活動詳情</a></li>
                                <li class="breadcrumb-item active" aria-current="page">訂單確認</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="event-dt-block p-80">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-12">
                    <div class="main-title checkout-title">
                        <h3>節目訂單確認</h3>
                        <h4 style="color: red">提醒：<input id="tOrderNo" type="text"
                                                           style="color: red; background: transparent; border: 0px"
                                                           value="訂單尚未建立，請勿離開"></h4>
                    </div>
                </div>
                <div class="col-lg-4 col-md-12">
                    <div class="countdown">
                        <div class="countdown-item">
                            <span id="minute"></span>分
                        </div>
                        <div class="countdown-item">
                            <span id="second"></span>秒
                        </div>
                    </div>
                </div>
                <div class="col-xl-8 col-lg-12 col-md-12">
                    <div class="checkout-block">
                        <div class="main-card">
                            <div class="bp-title">
                                <h4>訂購者資訊</h4>
                            </div>
                            <div class="bp-content bp-form">
                                <div class="row">
                                    <div class="col-lg-6 col-md-12">
                                        <div class="form-group mt-4">
                                            <label class="form-label">姓氏</label>
                                            <input id="lastName" class="form-control h_50" type="text"
                                                   placeholder="請輸入姓氏" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-12">
                                        <div class="form-group mt-4">
                                            <label class="form-label">名字</label>
                                            <input id="firstName" class="form-control h_50" type="text"
                                                   placeholder="請輸入名字" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-12">
                                        <div class="form-group mt-4">
                                            <label class="form-label">電子信箱</label>
                                            <input id="email" class="form-control h_50" type="text"
                                                   placeholder="請輸入電子信箱" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-12">
                                        <div class="form-group mt-4">
                                            <label class="form-label">帳單地址</label>
                                            <input id="address" class="form-control h_50" type="text"
                                                   placeholder="請輸入帳單地址" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--                        <div class="main-card mt-5">-->
                        <!--                            <div class="bp-title">-->
                        <!--                                <h4 id="orderAmount"> </h4>-->
                        <!--                            </div>-->
                        <!--                            <div class="bp-content bp-form">-->
                        <!--                                <div class="row">-->
                        <!--                                    <div class="col-lg-12 col-md-12">-->
                        <!--                                        <div class="form-group mt-4">-->
                        <!--                                            <label class="form-label">信用卡號碼</label>-->
                        <!--                                            <input class="form-control h_50" type="text" placeholder="請輸入信用卡號碼">-->
                        <!--                                        </div>-->
                        <!--                                    </div>-->
                        <!--                                    <div class="col-lg-6 col-md-12">-->
                        <!--                                        <div class="form-group mt-4">-->
                        <!--                                            <label class="form-label">到期日</label>-->
                        <!--                                            <input class="form-control h_50" type="text" placeholder="MM/YY"-->
                        <!--                                                   value="">-->
                        <!--                                        </div>-->
                        <!--                                    </div>-->
                        <!--                                    <div class="col-lg-6 col-md-12">-->
                        <!--                                        <div class="form-group mt-4">-->
                        <!--                                            <label class="form-label">CVV*</label>-->
                        <!--                                            <input class="form-control h_50" type="text"-->
                        <!--                                                   placeholder="請輸入信用卡安全碼">-->
                        <!--                                        </div>-->
                        <!--                                    </div>-->
                        <!--                                    <div class="col-lg-12 col-md-12">-->
                        <!--                                        <button class="main-btn btn-hover h_50 w-100 mt-5" type="button"-->
                        <!--                                                onclick="window.location.href='booking_confirmed.html'">確認訂單並付款-->
                        <!--                                        </button>-->
                        <!--                                    </div>-->
                        <!--                                </div>-->
                        <!--                            </div>-->
                        <!--                        </div>-->
                    </div>
                </div>
                <div class="col-xl-4 col-lg-12 col-md-12">
                    <div class="main-card order-summary">
                        <div class="bp-title">
                            <h4>節目訂單資訊</h4>
                        </div>
                        <div class="order-summary-content p_30">
                            <div class="event-order-dt">
                                <div class="event-thumbnail-img">
                                    <img id="aMainImg" src="images/event-imgs/img-7.jpg" alt="">
                                </div>
                                <div class="event-order-dt-content">
                                    <h5 id="aName">田馥甄一一巡迴演唱會-高雄場</h5>
                                    <span id="sessionSTime">2022/09/09 19:30</span>
                                </div>
                            </div>
                            <div id="ticketContainer" class="order-total-block">
                                <div class="order-total-dt">
                                    <div class="order-text">票券</div>
                                    <div id="ticketQTY" class="order-number"></div>
                                </div>
                                <!--                                <div class="order-total-dt">-->
                                <!--                                    <div id="ticketDetail_1" class="order-text">黃1A第1排第1位</div>-->
                                <!--                                    <div id="ticketAmount_1" class="order-number">TWD $4,500</div>-->
                                <!--                                </div>-->
                                <!--                                <div class="order-total-dt">-->
                                <!--                                    <div id="ticketDetail_2" class="order-text">黃1A第1排第2位</div>-->
                                <!--                                    <div id="ticketAmount_2" class="order-number">TWD $4,500</div>-->
                                <!--                                </div>-->
                            </div>

                            <div class="divider-line"></div>
                            <div class="order-total-dt">
                                <div class="order-text">總金額</div>
                                <div id="totalAmount" class="order-number ttl-clr"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12">
                        <button class="main-btn btn-hover h_50 w-100 mt-5" type="button"
                                onclick="addtorder()">確認訂單並付款
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Body End-->
<!-- Footer Start-->
<footer class="footer mt-auto">
    <!-- <div class="footer-top">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="footer-content">
                        <h4>Company</h4>
                        <ul class="footer-link-list">
                            <li><a href="about_us.html" class="footer-link">About Us</a></li>
                            <li><a href="help_center.html" class="footer-link">Help Center</a></li>
                            <li><a href="faq.html" class="footer-link">FAQ</a></li>
                            <li><a href="contact_us.html" class="footer-link">Contact Us</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-content">
                        <h4>Useful Links</h4>
                        <ul class="footer-link-list">
                            <li><a href="create.html" class="footer-link">Create Event</a></li>
                            <li><a href="sell_tickets_online.html" class="footer-link">Sell Tickets Online</a></li>
                            <li><a href="privacy_policy.html" class="footer-link">Privacy Policy</a></li>
                            <li><a href="term_and_conditions.html" class="footer-link">Terms & Conditions</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-content">
                        <h4>Resources</h4>
                        <ul class="footer-link-list">
                            <li><a href="pricing.html" class="footer-link">Pricing</a></li>
                            <li><a href="our_blog.html" class="footer-link">Blog</a></li>
                            <li><a href="refer_a_friend.html" class="footer-link">Refer a Friend</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="footer-content">
                        <h4>Follow Us</h4>
                        <ul class="social-links">
                            <li><a href="#" class="social-link"><i class="fab fa-facebook-square"></i></a>
                            <li><a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                            <li><a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                            <li><a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
                            <li><a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
                        </ul>
                    </div>
                    <div class="footer-content">
                        <h4>Download Mobile App</h4>
                        <div class="download-app-link">
                            <a href="#" class="download-btn"><img src="images/app-store.png" alt=""></a>
                            <a href="#" class="download-btn"><img src="images/google-play.png" alt=""></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
    <div class="footer-bottom">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="footer-copyright-text">
                        <p class="mb-0">© 2023, <strong>ezTicket</strong>. All rights reserved. Powered by
                            Gambolthemes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- Footer End-->

<script src="js/jquery-3.6.0.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="vendor/OwlCarousel/owl.carousel.js"></script>
<script src="vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
<script src="js/custom.js"></script>
<script src="js/memberLoginCheck.js"></script>
<script>

    // Set the date we're counting down to
    let countDownDate = new Date();
    countDownDate.setMinutes(countDownDate.getMinutes() + 10);

    // Update the countdown every 1 second
    let x = setInterval(function () {

        // Get today's date and time
        let now = new Date().getTime();

        // Find the distance between now and the countdown date
        let distance = countDownDate - now;

        // Time calculations for days, hours, minutes and seconds
        let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        let seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // Output the result in an element with id="demo"
        document.getElementById('minute').textContent = minutes;
        document.getElementById('second').textContent = seconds;

        // If the countdown is over, write some text
        if (distance < 0) {
            clearInterval(x);

            if (sessionStorage.getItem('toBuySeats') != null) {
                for (let id of JSON.parse(sessionStorage.getItem('toBuySeats'))) {
                    jsonObj = {
                        "sessionNo": sessionStorage.getItem("sessionNo"),
                        "seatNo": id,
                        "seatStatus": 1
                    };
                    fetch("seats/updateSeatStatus" + `?seatStatus=${jsonObj.seatStatus}&seatNo=${jsonObj.seatNo}&sessionNo=${jsonObj.sessionNo}`);
                }
            }

            sessionStorage.removeItem("activityNo");
            sessionStorage.removeItem("sessionNo");
            sessionStorage.removeItem("blockNo");
            sessionStorage.removeItem("toBuySeats");
            sessionStorage.removeItem("toBuyTickets");

            window.location.href = "/index.html";
        }
    }, 1000);

    let member_no;

    $(document).ready(function () {

            let activityNo = sessionStorage.getItem("activityNo");
            if (activityNo === null || activityNo === "") {
                location.href = `front-activity-event-explore_events.html`;
            }

            window.addEventListener('beforeunload', function (event) {
                event.preventDefault(); //chrome無效, ff有效, ie11有效
                event.returnValue = ''; //chrome有效, ff無效, ie11有效
                return ''; //chrome無效, ff無效, ie11有效
            });

            $.ajax({
                    url: '/member/getMemberInfo',
                    type: 'GET',
                    contentType: 'application/json',
                    async: false,
                    success: function (member) {
                        member_no = member['memberno'];
                        $('#lastName').val(`${member.mname.substr(0, 1)}`);
                        $('#firstName').val(`${member.mname.substr(1)}`);
                        $('#email').val(`${member.memail}`);
                        $('#address').val(`${member.address}`);
                    }
                }
            )
        }
    )

    let totalAmount = 0;

    fetch("/Session/findById" + `?sessionNo=${sessionStorage.getItem("sessionNo")}`)
        .then(resp => resp.json())
        .then((jsondata) => {
            $('#aName').text(`${jsondata.activity.aname}`);
            $('#sessionSTime').text(`${jsondata.sessionsTime}`);

            let showpic = jsondata.activity.aimgt;

            for (let i = 0; i < showpic.length; i++) {
                if (showpic[i].aimgMain == 1) {
                    $('#aMainImg').attr("src", `data:image/png;base64,${showpic[i].aimg}`);
                }
            }

            if (jsondata.activity.wetherSeat === 0) {
                $('#ticketQTY').text(`${sessionStorage.getItem("toBuyTickets")}`);

                fetch("/BlockPrice/findById" + `?blockNo=${sessionStorage.getItem("blockNo")}`)
                    .then(resp => resp.json())
                    .then((jsondata) => {
                        totalAmount = Number(sessionStorage.getItem("toBuyTickets")) * Number(jsondata.blockPrice);
                        $('#totalAmount').text(`TWD ${totalAmount}`);
                    })

            } else {
                let toBuySeats = JSON.parse(sessionStorage.getItem("toBuySeats"));
                $('#ticketQTY').text(`${toBuySeats.length}`);

                let counter = 0;
                for (let tBS of toBuySeats) {
                    ++counter;

                    $.ajax({
                        async: false,
                        type: 'GET',
                        url: "/seats/findById" + `?seatNo=${tBS}`,
                        dataType: "json",
                        success: function (jsondata) {
                            document.getElementById('ticketContainer').innerHTML += `
                            <div class="order-total-dt">
                                <div id="ticketDetail_${counter}" class="order-text">${jsondata.blockName} 第${jsondata.realX}排 第${jsondata.realY}位</div>
                                <div id="ticketAmount_${counter}" class="order-number">TWD ${jsondata.blockPrice.blockPrice}</div>
                            </div>
                            `;

                            totalAmount += jsondata.blockPrice.blockPrice;
                        }
                    });

                }

                $('#totalAmount').text(`TWD ${totalAmount}`);
            }
        })


    function addtorder() {
        let torderbody;
        let toBuyTickets = sessionStorage.getItem("toBuyTickets");
        let toBuySeats = JSON.parse(sessionStorage.getItem("toBuySeats"));


        if (toBuyTickets) { // 節目為非對號入座
            torderbody = {
                "memberno": member_no,
                "ttotal": totalAmount,
                "tcheckTotal": totalAmount,
                "orderTickets": [{
                    "sessionNo": sessionStorage.getItem("sessionNo"),
                    "seatNo": null,
                    "tqty": toBuyTickets,
                }]
            }
        } else { // 節目為對號入座
            let tTotal = totalAmount;
            let seats = [];

            for (seatNo of toBuySeats) {
                $.ajax({
                    async: false,
                    type: 'GET',
                    url: "/seats/findById" + `?seatNo=${seatNo}`,
                    dataType: "json",
                    success: function (jsondata) {
                        seats.push({
                            "sessionNo": jsondata.sessionNo,
                            "seatNo": seatNo,
                            "tqty": 1,
                        })
                    }
                });
            }

            torderbody = {
                "memberno": member_no,
                "ttotal": tTotal,
                "tcheckTotal": tTotal,
                "orderTickets": seats
            }
        }

        Swal.fire({
            title: '是否建立訂單？',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '是',
            cancelButtonText: '否'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Torder/addTorder',
                    type: 'POST',
                    data: JSON.stringify(torderbody),
                    contentType: 'application/json',
                    async: false,
                    success: function (data) {
                        sessionStorage.removeItem("activityNo");
                        sessionStorage.removeItem("sessionNo");
                        sessionStorage.removeItem("blockNo");
                        sessionStorage.removeItem("toBuySeats");
                        sessionStorage.removeItem("toBuyTickets");
                        $('body').append(data);
                        $('#allPayAPIForm').submit();
                    },
                    error: function () {
                        swal({
                            title: "建立失敗",
                            icon: "error",
                            closeOnClickOutside: false,
                        });
                    }
                });
            } else {
                return Promise.reject('取消操作');
            }
        })
    }

    window.addEventListener('beforeunload', function () {
        if (sessionStorage.getItem('toBuySeats') != null) {
            for (let id of JSON.parse(sessionStorage.getItem('toBuySeats'))) {
                jsonObj = {
                    "sessionNo": sessionStorage.getItem("sessionNo"),
                    "seatNo": id,
                    "seatStatus": 1
                };
                fetch("seats/updateSeatStatus" + `?seatStatus=${jsonObj.seatStatus}&seatNo=${jsonObj.seatNo}&sessionNo=${jsonObj.sessionNo}`);
            }
        }

        sessionStorage.removeItem("activityNo");
        sessionStorage.removeItem("sessionNo");
        sessionStorage.removeItem("blockNo");
        sessionStorage.removeItem("toBuySeats");
        sessionStorage.removeItem("toBuyTickets");
    });

</script>

</body>

</html>