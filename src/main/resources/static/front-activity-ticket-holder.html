<!DOCTYPE html>
<html lang="en" class="h-100">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, shrink-to-fit=9">
	<meta name="description" content="Gambolthemes">
	<meta name="author" content="Gambolthemes">
	<title>ezTicket - 一站式購票體驗</title>

	<!-- Favicon Icon -->
	<link rel="icon" type="image/png" href="images/ezTicket.png">

	<!-- Stylesheets -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
		rel="stylesheet">
	<link href='vendor/unicons-2.0.1/css/unicons.css' rel='stylesheet'>
	<link href="css/style.css" rel="stylesheet">
	<link href="css/responsive.css" rel="stylesheet">
	<link href="css/night-mode.css" rel="stylesheet">

	<!-- Vendor Stylesheets -->
	<link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
	<link href="vendor/OwlCarousel/assets/owl.carousel.css" rel="stylesheet">
	<link href="vendor/OwlCarousel/assets/owl.theme.default.min.css" rel="stylesheet">
	<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="vendor/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">

	<!-- <style>
		.main-btn {
			font-size: 16px;
			color: #fff;
			font-weight: 400;
			text-align: center;
			background: #102743;
			height: 50px;
			display: inline-block;
			line-height: 49px;
			padding: 0 13px;
			border-radius: 3px;
			border: 1px solid #102743;
		}
	</style> -->
</head>

<body class="d-flex flex-column h-100">
   <!-- Header Start-->
   <header class="header">
	<div class="header-inner">
		<nav
			class="navbar navbar-expand-lg bg-barren barren-head navbar fixed-top justify-content-sm-start pt-0 pb-0">
			<div class="container">
				<button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
					data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
					<span class="navbar-toggler-icon">
						<i class="fa-solid fa-bars"></i>
					</span>
				</button>
				<a class="navbar-brand order-1 order-lg-0 ml-lg-0 ml-2 me-auto" href="index.html">
					<div class="res-main-logo">
						<img src="images/ezTicket-icon.svg" alt="">
					</div>
					<div class="main-logo" id="logo">
						<img src="images/ezTicket.svg" alt="">
						<img class="logo-inverse" src="images/dark-logo.svg" alt="">
					</div>
				</a>
				<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar"
					aria-labelledby="offcanvasNavbarLabel">
					<div class="offcanvas-header">
						<div class="offcanvas-logo" id="offcanvasNavbarLabel">
							<img src="images/ezTicket-icon.svg" alt="">
						</div>
						<button type="button" class="close-btn" data-bs-dismiss="offcanvas" aria-label="Close">
							<i class="fa-solid fa-xmark"></i>
						</button>
					</div>
					<div class="offcanvas-body">
						<ul class="navbar-nav justify-content-end flex-grow-1 pe_5">
							<li class="nav-item">
								<a class="nav-link active" aria-current="page"
									href="front-activity-event-explore_events.html"
									style="color:black !important">探索節目</a>
							</li>
							<li class="nav-item">
								<a class="nav-link active" aria-current="page"
									href="front-product-explore_products.html"
									style="color:black !important">探索商品</a>
							</li>
							<li class="nav-item">
								<a class="nav-link active" aria-current="page" href="#"
									style="color:black !important">常見問題</a>
							</li>
							<li class="nav-item">
								<a class="nav-link active" aria-current="page" href="#"
									style="color:black !important">最新消息</a>
							</li>

						</ul>
					</div>
				</div>
				<div class="right-header order-2">
					<ul class="align-self-stretch">
						<li>
							<a href="front-activity-event-explore_events.html" class="create-btn btn-hover">
								<i class="fa-solid fa-calendar-days"></i>
								<span>節目訂票</span>
							</a>
							<a href="front-product-explore_products.html" class="create-btn btn-hover">
								<i class="fa-sharp fa-solid fa-bag-shopping"></i>
								<span>聯名商品</span>
							</a>
						</li>
						<li>

						</li>
						<li class="dropdown account-dropdown">
							<a href="#" class="account-link" role="button" id="accountClick"
								data-bs-auto-close="outside" data-bs-toggle="dropdown" aria-expanded="false">
								<img class="D-mimg" src="images/profile-imgs/img-13.jpg" alt="">
								<i class="fas fa-caret-down arrow-icon"></i>
							</a>
							<ul class="dropdown-menu dropdown-menu-account dropdown-menu-end"
								aria-labelledby="accountClick">
								<li>
									<div class="dropdown-account-header">
										<div class="account-holder-avatar">
											<img class="D-mimg" src="images/profile-imgs/img-13.jpg" alt="">
										</div>
										<h5 class="D-mname">會員名稱</h5>
										<p class="D-memail">johndoe@example.com</p>
									</div>
								</li>
								<li class="profile-link">
									<a class="dropdown-item pe-5" href="front-users-member-profile.html">會員資訊</a>
									<a class="dropdown-item pe-5" href="front-users-mem-sign-in.html">登入</a>
									<a class="dropdown-item pe-5" href="front-users-sign-up.html">註冊</a>
									<a class="dropdown-item pe-5" href="front-users-forgot-pwd.html">忘記密碼</a>

								</li>
							</ul>
						</li>
						<li class="dropdown account-dropdown">
							<a href="front-product-shopping_cart.html" class="account-link">
								<div id="cart">
									<img src="images/profile-imgs/cart2.jpg">
									<span class="badge" style="color:#102743 ;">0</span>
								</div>
							</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>
		<div class="overlay"></div>
	</div>
</header>
<!-- Header End-->
	<!-- Body Start-->
	<div class="wrapper">
		<div class="profile-banner">
			<!-- <div class="container-fluid">
				<div class="row">
					<div class="col-md-12">
						<div class="d-main-title">
							<h3 style="margin: 3% 0 0 6%;"><i class="fa-solid fa-gift me-3"></i>我的票夾</h3>
						</div>
					</div>
				</div>
			</div> -->
			<div class="user-dt-block">
				<div class="container">
					<div class="row">
						<div class="col-md-12">
							<div class="d-main-title">
								<h3 style="margin: 2% 0 0 0"><i class="fa-solid fa-gift me-3"></i>我的票夾</h3>
							</div>
							<div class="right-profile">
								<div class="profile-tabs">
									<ul class="nav nav-pills nav-fill p-2 garren-line-tab" id="myTab" role="tablist">
										<li class="nav-item">
											<a class="nav-link active show" id="orders-tab" data-bs-toggle="tab" href="#orders"
												role="tab" aria-controls="orders" aria-selected="false"><i
													class="fa-solid fa-box"></i>即將到來</a>
										</li>
										<li class="nav-item">
											<a class="nav-link" id="history-tab" data-bs-toggle="tab" href="#history"
												role="tab" aria-controls="history" aria-selected="false"><i
													class="fa-solid fa-history"></i>歷史票券</a>
										</li>
									</ul>
									<div class="tab-content" id="myTabContent">
										<div class="tab-pane fade active show" id="orders" role="tabpanel"
											aria-labelledby="orders-tab">
											<div id="incoming">
											</div>
										</div>
										<div class="tab-pane fade" id="history" role="tabpanel"
											aria-labelledby="history-tab">
											<div id="outdated">
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 分票開始-->
	<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="false">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="couponModalLabel">分票</h5>
					<button type="button" class="close-model-btn" data-bs-dismiss="modal" aria-label="Close">
						<i class="fa-solid fa-xmark"></i></button>
				</div>
				<div class="modal-body">
					<div class="model-content main-form">
						<div class="row">
							<div class="col-lg-12 col-md-12">
								<div class="form-group">
									<div class="form-group mt-4" style="display: none;">
										<label class="form-label">票券編號</label>
										<input id="hiddenCollectno" class="form-control h_40" type="text" value="">
									</div>
									<div class="form-group mt-4">
										<label>請輸入欲轉贈票券的會員帳號</label>
										<input id="transferEmail" class="form-control h_40" type="text" maxlength="100"
											placeholder="請輸入電子信箱" value="">
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="co-main-btn min-width btn-hover h_40" data-bs-target="#aboutModal"
							data-bs-toggle="modal" data-bs-dismiss="modal">取消</button>
						<button type="button" class="main-btn min-width btn-hover h_40" onclick="transfer()">送出</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 新增模板結束-->

	<!-- Body End-->
	<!-- Footer Start-->
	<footer class="footer mt-auto">
		<!-- <div class="footer-top">
			<div class="container">
				<div class="row">
					<div class="col-lg-3 col-md-6">
						<div class="footer-content">
							<h4>Company</h4>
							<ul class="footer-link-list">
								<li><a href="about_us.html" class="footer-link">About Us</a></li>
								<li><a href="help_center.html" class="footer-link">Help Center</a></li>
								<li><a href="faq.html" class="footer-link">FAQ</a></li>
								<li><a href="contact_us.html" class="footer-link">Contact Us</a></li>
							</ul>
						</div>
					</div>
					<div class="col-lg-3 col-md-6">
						<div class="footer-content">
							<h4>Useful Links</h4>
							<ul class="footer-link-list">
								<li><a href="create.html" class="footer-link">Create Event</a></li>
								<li><a href="sell_tickets_online.html" class="footer-link">Sell Tickets Online</a></li>
								<li><a href="privacy_policy.html" class="footer-link">Privacy Policy</a></li>
								<li><a href="term_and_conditions.html" class="footer-link">Terms & Conditions</a></li>
							</ul>
						</div>
					</div>
					<div class="col-lg-3 col-md-6">
						<div class="footer-content">
							<h4>Resources</h4>
							<ul class="footer-link-list">
								<li><a href="pricing.html" class="footer-link">Pricing</a></li>
								<li><a href="our_blog.html" class="footer-link">Blog</a></li>
								<li><a href="refer_a_friend.html" class="footer-link">Refer a Friend</a></li>
							</ul>
						</div>
					</div>
					<div class="col-lg-3 col-md-6">
						<div class="footer-content">
							<h4>Follow Us</h4>
							<ul class="social-links">
								<li><a href="#" class="social-link"><i class="fab fa-facebook-square"></i></a>
								<li><a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
								<li><a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
								<li><a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
								<li><a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
							</ul>
						</div>
						<div class="footer-content">
							<h4>Download Mobile App</h4>
							<div class="download-app-link">
								<a href="#" class="download-btn"><img src="images/app-store.png" alt=""></a>
								<a href="#" class="download-btn"><img src="images/google-play.png" alt=""></a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div> -->
		<div class="footer-bottom">
			<div class="container">
				<div class="row">
					<div class="col-12">
						<div class="footer-copyright-text">
							<p class="mb-0">© 2023, <strong>ezTicket</strong>. All rights reserved. Powered by CGA106Group2</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</footer>
	<!-- Footer End-->


	<script src="js/jquery-3.6.0.min.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="vendor/OwlCarousel/owl.carousel.js"></script>
	<script src="vendor/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
	<script src="js/custom.js"></script>
	<script src="js/night-mode.js"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<!-- kai 會員登入狀態驗證(導向版) -->
	<script src="js/memberLoginCheck-location.href.js"></script>


	<!-- 所有擁有的票券 -->
	<!-- 會員編號先寫死 -->
	<script>
		// new URLSearchParams(window.location.search).get("memberno");
		let memberno = null;
		const formData = new FormData();
		fetch('member/getMemberInfo')
			.then(response => response.json())
			.then(data => {
				memberno = data.memberno;
				// console.log(memberno);
				formData.append('action', 'allMyTickets');
				formData.append('memberno', memberno);
				// console.log([...formData.entries()]);
				return formData;
			})
			.then((formData) => {
				getAllMyTickets(formData);
			});

		function getAllMyTickets(formData) {
			fetch('collect', {
				method: 'POST',
				headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
				body: new URLSearchParams(formData)
			})
				// .then(() => console.log('fetch success'))
				.then(resp => {
					// console.log(resp);
					return resp.json();
				})
				.then(list => {
					showMyTickets(list);
				})
				.catch(err => {
					console.log('發生錯誤:', err);
				});
		}

	</script>

	<script>
		function showMyTickets(list) {
			const incoming = document.getElementById('incoming');
			const outdated = document.getElementById('outdated');
			incoming.innerHTML = '';
			outdated.innerHTML = '';
			let ticketCount = 1;
			for (let ticket of list) {
				const sessionetime = new Date(ticket.sessionetime);
				const now = new Date();
				if (sessionetime.getTime() > now.getTime()) {
					incoming.innerHTML += `
				<div class="main-card mt-4">
					<div class="card-top p-4">
													<div class="card-event-img">
														<img src="/collect?action=getImg&memberno=${ticket.memberno}&collectno=${ticket.collectno}" alt="" style="display:block;width:100%;height:100%;">
													</div>
													<div class="card-event-dt">
														<h5>${ticket.aname}</h5>
														<div class="invoice-id">票券編號：<span>${ticket.collectno}</span></div>
													</div>
													<div class="rs ms-auto mt_r4" style="float:right !important">
														<div>													
															<a href="/collect?action=oneTicket&collectno=${ticket.collectno}"
																class="main-btn btn-hover h_40 w-100" style="margin-top: 10px;">取票</a>
														</div>
														<div>
																<button class="pe-4 ps-4 co-main-btn min-width" data-bs-toggle="modal"
																data-bs-target="#couponModal" data-bs-collectno="${ticket.collectno}" style="margin-top: 10px;">分票</button>
														</div>
													</div>
												</div>
												<div class="card-bottom">
													<div class="card-bottom-item">
														<div class="card-icon">
															<i class="fa-solid fa-calendar-days"></i>
														</div>
														<div class="card-dt-text">
															<h6>節目開始時間</h6>
															<span>${ticket.sessionstime}</span>
														</div>
													</div>
													<div class="card-bottom-item">
														<div class="card-icon">
															<i class="fa-solid fa-location-dot"></i>
														</div>
														<div class="card-dt-text">
															<h6>節目地點</h6>
															<span>${ticket.aplace}</span>
														</div>
													</div>
													<div class="card-bottom-item">
														<div class="card-icon">
															<i class="fa-solid fa-ticket"></i>
														</div>
														<div class="card-dt-text">
															<h6>座位</h6>
															<span id='withSeat${ticketCount}'>${ticket.blockname} ${ticket.realx}排 ${ticket.realy}號</span>
														</div>
													</div>
													<div class="card-bottom-item">
														<div class="card-icon">
															<i class="fa-solid fa-money-bill"></i>
														</div>
														<div class="card-dt-text">
															<h6>票券持有人</h6>
															<span>${ticket.mname}</span>
														</div>
													</div>
												</div>
				`;
					let realx = ticket.realx;
					let realy = ticket.realy;
					if (realx === undefined || realy === undefined || realx === null || realy === null) {
						const withSeat = document.getElementById(`withSeat${ticketCount}`);
						withSeat.textContent = '非對號座';
					}
				} else {
					outdated.innerHTML += `
				<div class="main-card mt-4">
					<div class="card-top p-4">
													<div class="card-event-img">
														<img src="/collect?action=getImg&memberno=${ticket.memberno}&collectno=${ticket.collectno}" alt="" style="display:block;width:100%;height:100%;">
													</div>
													<div class="card-event-dt">
														<h5>${ticket.aname}</h5>
														<div class="invoice-id">票券編號：<span>${ticket.collectno}</span></div>
													</div>
													<div class="rs ms-auto mt_r4" style="float:right !important">
														<div>													
															<a href="/collect?action=oneTicket&collectno=${ticket.collectno}"
																class="main-btn btn-hover h_40 w-100" style="margin-top: 10px;">瀏覽紀錄</a>
														</div>
													</div>
												</div>
												<div class="card-bottom">
													<div class="card-bottom-item">
														<div class="card-icon">
															<i class="fa-solid fa-calendar-days"></i>
														</div>
														<div class="card-dt-text">
															<h6>節目開始時間</h6>
															<span>${ticket.sessionstime}</span>
														</div>
													</div>
													<div class="card-bottom-item">
														<div class="card-icon">
															<i class="fa-solid fa-location-dot"></i>
														</div>
														<div class="card-dt-text">
															<h6節目地點</h6>
															<span>${ticket.aplace}</span>
														</div>
													</div>
													<div class="card-bottom-item">
														<div class="card-icon">
															<i class="fa-solid fa-ticket"></i>
														</div>
														<div class="card-dt-text">
															<h6>座位</h6>
															<span id='withSeat${ticketCount}'>${ticket.blockname} ${ticket.realx}排 ${ticket.realy}號</span>
														</div>
													</div>
													<div class="card-bottom-item">
														<div class="card-icon">
															<i class="fa-solid fa-money-bill"></i>
														</div>
														<div class="card-dt-text">
															<h6>票券持有人</h6>
															<span>${ticket.mname}</span>
														</div>
													</div>
												</div>
				`;
					let realx = ticket.realx;
					// console.log(realx);
					let realy = ticket.realy;
					// console.log(realy);
					if (realx === undefined || realy === undefined || realx === null || realy === null) {
						const withSeat = document.getElementById(`withSeat${ticketCount}`);
						withSeat.textContent = '非對號座';
					}
				}
				ticketCount++;
			}
		}
	</script>

	<!-- 彈跳視窗設定 -->
	<script>
		const couponModal = document.getElementById('couponModal')
		couponModal.addEventListener('show.bs.modal', function (event) {
			// Button that triggered the modal
			const button = event.relatedTarget;
			// Extract info from data-bs-* attributes
			const modalCollectno = button.getAttribute('data-bs-collectno');
			$("#hiddenCollectno").val(modalCollectno);
		});
	</script>

	<!-- 分票按鈕 -->
	<script>
		function transfer() {
			if ($.trim($("#transferEmail").val()) === "") {
				Swal.fire(
					{
						title: "內容不能空白！",
						text: "請再次檢查您輸入的信箱是否正確",
						icon: 'error',
						confirmButtonText: '確定'
					}
				);
			} else {
				Swal.fire({
					title: "票券分送後不能復原。確定送出嗎？",
					showCancelButton: true,
					confirmButtonColor: '#102743',
					cancelButtonText: "取消",
					confirmButtonText: '確定',
					reverseButtons: true
				}).then(function (result) {
					if (result.value) {
						const collectnoval = $("#hiddenCollectno").val();
						const emailval = $("#transferEmail").val();
						fetch(`/EditCollect/transfer/${collectnoval}?memail=${emailval}`, {
							method: 'GET',
							headers: {
								'Content-Type': 'application/json'
							}
						})
							.then(response => {
								if (!response.ok) {
									throw new Error('Ticket not update');
								}
								return response.json()
							})
							.then(result => {
								console.log(result);
								if (result === true) {
									Swal.fire({
										title: "已送出資料！",
										icon: 'success',
										confirmButtonText: '確定',
										confirmButtonColor: '#102743',
										preConfirm: setTimeout(() => {
											document.location.reload();
										}, 1000)
									});
								}
								else if (result === false) {
									Swal.fire({
										title: "查無會員資料",
										text: "請查明後再試",
										icon: 'error',
										confirmButtonText: '確定',
										confirmButtonColor: '#102743',
									});
								} else {
									Swal.fire({
										title: "系統忙碌中",
										text: "請稍候再試",
										icon: 'info',
										confirmButtonText: '確定',
										confirmButtonColor: '#102743',
									});
								}
							})
							.catch(error => {
								console.error('Error:', error.message);
							});
					} else {
						Swal.fire({ text: "返回編輯", timer: 1500, showConfirmButton: true, confirmButtonColor: '#102743' });
					}
				});
			}

		};
	</script>
</body>

</html>